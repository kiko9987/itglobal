<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>신규 프로젝트 등록 (자동 코드 생성)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container {
            max-width: 600px;
            margin-top: 2rem;
        }
        .form-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .auto-code {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 1.1em;
            text-align: center;
            margin: 10px 0;
        }
        .error {
            color: #dc3545;
            font-size: 0.875em;
        }
        .success {
            color: #198754;
            font-size: 0.875em;
        }
        .loading {
            display: none;
        }
        .required {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">
                    <i class="fas fa-plus-circle"></i>
                    신규 프로젝트 등록
                </h2>
                
                <div class="form-section">
                    <h5>프로젝트 코드 자동 생성</h5>
                    <p class="text-muted mb-0">사업자와 담당자를 선택하면 프로젝트 코드가 자동으로 생성됩니다.</p>
                </div>

                <form id="projectForm">
                    <!-- 기본 정보 -->
                    <div class="form-section">
                        <h6 class="mb-3">기본 정보</h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label for="company" class="form-label">사업자 <span class="required">*</span></label>
                                <select class="form-select" id="company" name="사업자" required>
                                    <option value="">사업자 선택</option>
                                </select>
                                <div class="error" id="company-error"></div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="owner" class="form-label">담당자 <span class="required">*</span></label>
                                <select class="form-select" id="owner" name="담당자" required>
                                    <option value="">담당자 선택</option>
                                </select>
                                <div class="error" id="owner-error"></div>
                            </div>
                        </div>
                        
                        <!-- 자동 생성된 프로젝트 코드 표시 -->
                        <div class="mt-3">
                            <label class="form-label">생성될 프로젝트 코드</label>
                            <div class="auto-code" id="generated-code">
                                사업자와 담당자를 선택하면 자동 생성됩니다
                            </div>
                        </div>
                    </div>

                    <!-- 현장 정보 -->
                    <div class="form-section">
                        <h6 class="mb-3">현장 정보</h6>
                        
                        <div class="mb-3">
                            <label for="address" class="form-label">현장 주소 <span class="required">*</span></label>
                            <textarea class="form-control" id="address" name="현장 주소" rows="2" required placeholder="현장 주소를 상세히 입력하세요"></textarea>
                            <div class="error" id="address-error"></div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label for="client" class="form-label">거래처</label>
                                <input type="text" class="form-control" id="client" name="거래처" placeholder="거래처명">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="work-content" class="form-label">공사 내용</label>
                                <input type="text" class="form-control" id="work-content" name="공사 내용" placeholder="냉난방기 설치 등">
                            </div>
                        </div>
                    </div>

                    <!-- 추가 정보 (선택사항) -->
                    <div class="form-section">
                        <h6 class="mb-3">추가 정보 (선택사항)</h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label for="site-manager" class="form-label">현장 담당자</label>
                                <input type="text" class="form-control" id="site-manager" name="현장 담당자" placeholder="현장 담당자명">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="manager-phone" class="form-label">담당자 연락처</label>
                                <input type="tel" class="form-control" id="manager-phone" name="담당자 연락처" placeholder="010-0000-0000">
                            </div>
                        </div>
                    </div>

                    <!-- 버튼 -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-secondary me-md-2" onclick="history.back()">취소</button>
                        <button type="submit" class="btn btn-primary" id="submit-btn">
                            <span class="loading spinner-border spinner-border-sm me-2" role="status"></span>
                            프로젝트 등록
                        </button>
                    </div>
                    
                    <div id="form-message" class="mt-3"></div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let options = { companies: [], owners: [] };

        // 페이지 로드 시 옵션 데이터 로드
        async function loadOptions() {
            try {
                const response = await fetch('/api/meta/options');
                if (response.ok) {
                    options = await response.json();
                    
                    // 사업자 드롭다운 채우기
                    const companySelect = document.getElementById('company');
                    options.companies.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company;
                        option.textContent = company;
                        companySelect.appendChild(option);
                    });
                    
                    // 담당자 드롭다운 채우기
                    const ownerSelect = document.getElementById('owner');
                    options.owners.forEach(owner => {
                        const option = document.createElement('option');
                        option.value = owner;
                        option.textContent = owner;
                        ownerSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('옵션 로드 오류:', error);
            }
        }

        // 프로젝트 코드 미리보기
        function updateProjectCodePreview() {
            const company = document.getElementById('company').value;
            const owner = document.getElementById('owner').value;
            const codeDisplay = document.getElementById('generated-code');
            
            if (company && owner) {
                // 간단한 미리보기 (실제 생성은 서버에서)
                codeDisplay.textContent = `${company}-${owner} → 자동 생성됨`;
                codeDisplay.style.backgroundColor = '#e8f5e8';
            } else {
                codeDisplay.textContent = '사업자와 담당자를 선택하면 자동 생성됩니다';
                codeDisplay.style.backgroundColor = '#e3f2fd';
            }
        }

        // 이벤트 리스너
        document.getElementById('company').addEventListener('change', updateProjectCodePreview);
        document.getElementById('owner').addEventListener('change', updateProjectCodePreview);

        // 폼 제출
        document.getElementById('projectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            const loading = submitBtn.querySelector('.loading');
            const formMessage = document.getElementById('form-message');
            
            // 로딩 상태
            submitBtn.disabled = true;
            loading.style.display = 'inline-block';
            formMessage.innerHTML = '';
            
            // 폼 데이터 수집
            const formData = new FormData(this);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            try {
                const response = await fetch('/api/projects/auto', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    formMessage.innerHTML = `
                        <div class="alert alert-success">
                            <strong>등록 완료!</strong> 프로젝트 코드: <code>${result.project_code}</code>
                        </div>
                    `;
                    this.reset();
                    updateProjectCodePreview();
                    
                    // 3초 후 목록 페이지로 이동
                    setTimeout(() => {
                        window.location.href = '/projects';
                    }, 2000);
                    
                } else {
                    formMessage.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>등록 실패:</strong> ${result.error}
                        </div>
                    `;
                }
                
            } catch (error) {
                formMessage.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>오류:</strong> 서버 통신 중 오류가 발생했습니다.
                    </div>
                `;
                console.error('등록 오류:', error);
            } finally {
                // 로딩 상태 해제
                submitBtn.disabled = false;
                loading.style.display = 'none';
            }
        });

        // 페이지 로드 시 실행
        loadOptions();
    </script>
</body>
</html>