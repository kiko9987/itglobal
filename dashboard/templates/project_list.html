<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프로젝트 관리 - 냉난방기 설치 공사 관리</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <!-- DataTables FixedHeader CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.bootstrap5.min.css">
    
    <style>
        /* ===== IT GLOBAL 프리미엄 디자인 시스템 ===== */
        :root {
            /* Brand Colors - 로고가 돋보이는 어두운 베이스 + 오렌지 포인트 */
            --primary-color: #FF6B35;
            --primary-dark: #E55A2B;
            --primary-light: #FF8A65;
            
            /* Dark Theme Base Colors */
            --dark-primary: #1a1a1a;
            --dark-secondary: #2d2d2d;
            --dark-accent: #3a3a3a;
            
            /* Status Colors */
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
            
            /* Neutral Colors */
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            
            /* Typography */
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            --font-size-4xl: 2.25rem;
            
            /* Spacing */
            --border-radius-sm: 6px;
            --border-radius: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        /* Base Styles */
        body {
            background-color: var(--gray-50);
            color: var(--gray-800);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
        }
        
        /* Header - 연한 파스텔 톤 배경 */
        .header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #495057;
            padding: 0;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            border-bottom: 3px solid var(--gray-300);
            min-height: auto;
        }
        
        /* 연한 장식 요소들 */
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255, 107, 53, 0.05) 0%, transparent 70%);
            border-radius: 50%;
        }
        
        .header h1 {
            font-weight: 700;
            font-size: var(--font-size-3xl);
            margin-bottom: 0.25rem;
            letter-spacing: -0.025em;
            position: relative;
            z-index: 2;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .header .d-flex {
            align-items: flex-start !important;
            justify-content: flex-start !important;
            padding-left: 2rem;
        }
        
        .header .logo {
            width: 216px;
            height: 216px;
            object-fit: contain;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.15));
            transition: all 0.3s ease;
            transform: translateY(-50px);
        }
        
        .header .logo:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 8px 20px rgba(0,0,0,0.25));
        }
        
        .header .logo-subtitle {
            font-size: 1.1rem;
            font-weight: 500;
            color: #495057;
            opacity: 0.9;
            line-height: 1.4;
            white-space: nowrap;
            margin: 0;
            align-self: center;
        }
        
        .header p {
            font-size: var(--font-size-base);
            opacity: 0.95;
            margin-bottom: 0;
            position: relative;
            z-index: 2;
            font-weight: 400;
        }
        
        /* Content Container */
        .content-container {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: 1.5rem;  /* 2rem → 1.5rem */
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-200);
        }
        
        /* 구분 뱃지 스타일 - 크기 키움 */
        .project-badge {
            padding: 0.3rem 0.6rem;
            border-radius: 0.3rem;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }
        
        .project-badge.r-type {
            background-color: #f8d7da; /* 연한 빨간색 */
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .project-badge.g-type {
            background-color: #d4edda; /* 연한 초록색 */
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .project-badge.p-type {
            background-color: #e2d9f3; /* 연한 보라색 */
            color: #4a2c70;
            border: 1px solid #d1c4e9;
        }
        
        .project-badge.i-type {
            background-color: #ffe0db; /* 연한 주황색 */
            color: #8b3d28;
            border: 1px solid #ffd0c4;
        }
        
        .badge.manager-badge {
            padding: 0.3rem 0.6rem !important;
            border-radius: 0.3rem !important;
            font-size: 0.8rem !important;
            font-weight: 600 !important;
            color: #333 !important;
            border: 1px solid rgba(0,0,0,0.1) !important;
            display: inline-block !important;
        }
        
        .manager-badge.management {
            border: 2px solid #ffc107;
            background-color: #fff3cd;
            color: #856404;
            font-weight: 600;
        }
        
        .manager-badge.resigned {
            background-color: #e9ecef;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }
        
        .badge.company-badge {
            padding: 0.3rem 0.6rem !important;
            border-radius: 0.3rem !important;
            font-size: 0.8rem !important;
            font-weight: 600 !important;
            color: #333 !important;
            border: 1px solid rgba(0,0,0,0.1) !important;
            display: inline-block !important;
        }

        /* Filter Section - 컨테이너 내에서 고정 */
        .filter-section-sticky {
            position: sticky;
            top: 0;
            z-index: 1020;
            background: white;
            margin-bottom: 1.25rem;
        }
        
        .filter-section {
            background: #fafbfc;
            padding: 0.75rem;
            margin: 0;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius-lg);
        }
        
        .filter-section h5 {
            color: var(--gray-800);
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.9rem;
        }
        
        .filter-section h5 i {
            color: var(--primary-color);
            font-size: 0.8rem;
        }
        
        .filter-section .form-label {
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
            font-weight: 500;
            color: var(--gray-700);
        }
        
        .filter-section .row {
            --bs-gutter-y: 0.25rem;
        }
        
        /* Buttons */
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: var(--border-radius);
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
            color: white;
            border-radius: var(--border-radius);
            font-weight: 500;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
            border-radius: var(--border-radius);
            font-weight: 500;
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
            border-radius: var(--border-radius);
            font-weight: 500;
        }
        
        /* 필터 섹션 버튼 높이 통일 (축소) */
        .filter-section .btn {
            height: 32px;
            padding: 0.3rem 0.5rem;
            font-size: 0.8rem;
            line-height: 1.3;
        }
        
        /* Form Elements (축소) */
        .filter-section .form-select, 
        .filter-section .form-control {
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-300);
            font-size: 0.8rem;
            transition: all 0.2s ease;
            height: 32px;
            padding: 0.3rem 0.5rem;
        }
        
        /* 필터 선택 시 강조 스타일 */
        .filter-section .form-select.filter-selected, 
        .filter-section .form-control.filter-selected {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.15) !important;
            background-color: rgba(255, 107, 53, 0.03) !important;
        }
        
        /* 일반 Form Elements (필터 외부) */
        .form-select, .form-control {
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-300);
            font-size: var(--font-size-sm);
            transition: all 0.2s ease;
            height: 38px;
            padding: 0.5rem 0.75rem;
        }
        
        .form-select:focus, .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        /* Table Section - 컨테이너 내 테이블 영역 */
        .table-section {
            overflow: hidden;
        }
        
        .table-wrapper {
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            background: white;
        }
        
        .table-wrapper table {
            width: 100%;
            margin: 0;
            table-layout: fixed;  /* 고정 너비 유지 */
            background: white;
            min-width: 100%;
        }
        
        .table th {
            background-color: #f1f3f4;
            color: #495057;
            border: 1px solid #e9ecef;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 1rem 0.75rem;
            text-align: center;
            vertical-align: middle;
            position: sticky;  /* 테이블 내에서 헤더 고정 */
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        /* DataTables 정렬 아이콘 스타일 조정 */
        .table th.sorting,
        .table th.sorting_asc, 
        .table th.sorting_desc {
            position: relative !important;
            padding-right: 35px !important;
        }
        
        
        /* 모든 테이블 헤더 중앙정렬 (정렬 아이콘 고려) */
        .table th:nth-child(1),  /* 프로젝트 코드 */
        .table th:nth-child(2),  /* 담당자 */
        .table th:nth-child(3),  /* 거래처 */
        .table th:nth-child(4),  /* 현장 주소 */
        .table th:nth-child(5),  /* 공사 내용 */
        .table th:nth-child(6),  /* 공사 시작 */
        .table th:nth-child(7),  /* 공사 종료 */
        .table th:nth-child(8),  /* 총액 */
        .table th:nth-child(9),  /* 미수금 */
        .table th:nth-child(10) { /* 상태 */
            text-align: center !important;
            padding-left: 15px !important;
        }
        
        /* 중앙정렬 헤더의 텍스트 위치 조정 (정렬 아이콘 공간 확보) */
        .table th:nth-child(1).sorting,
        .table th:nth-child(2).sorting,
        .table th:nth-child(3).sorting,
        .table th:nth-child(4).sorting,  /* 현장 주소 추가 */
        .table th:nth-child(5).sorting,  /* 공사 내용 추가 */
        .table th:nth-child(6).sorting,
        .table th:nth-child(7).sorting,
        .table th:nth-child(8).sorting,
        .table th:nth-child(9).sorting,
        .table th:nth-child(10).sorting {
            padding-left: 15px !important;
        }
        
        /* 테이블 데이터 셀 - 헤더와 정확히 동일한 중앙정렬 (화살표 공간 고려) */
        .table td:nth-child(2),  /* 담당자 */
        .table td:nth-child(3),  /* 거래처 */
        .table td:nth-child(6),  /* 공사 시작 */
        .table td:nth-child(7),  /* 공사 종료 */
        .table td:nth-child(8),  /* 총액 */
        .table td:nth-child(9),  /* 미수금 */
        .table td:nth-child(10) {  /* 상태 */
            text-align: center !important;
            vertical-align: middle !important;
            padding-left: 15px !important;
            padding-right: 35px !important;  /* 헤더와 동일한 오른쪽 패딩 (화살표 공간) */
        }
        
        /* 프로젝트 코드 데이터는 왼쪽 정렬 (뱃지 정렬용) */
        .table td:nth-child(1) {
            text-align: left !important;
            vertical-align: middle !important;
            padding-left: 15px !important;
            padding-right: 35px !important;
        }
        
        /* 현장주소, 공사내용 데이터 셀 - 텍스트 길이 때문에 왼쪽 정렬 유지 */
        .table td:nth-child(4),  /* 현장 주소 */
        .table td:nth-child(5) { /* 공사 내용 */
            text-align: left !important;
            vertical-align: middle !important;
            padding-left: 15px !important;
        }
        
        /* 금액 셀도 중앙정렬로 변경 */
        .table td.amount-cell {
            text-align: center !important;
            padding-left: 15px !important;
            padding-right: 35px !important;
        }
        
        .table td {
            vertical-align: middle;
            font-size: var(--font-size-sm);
            padding: 0.75rem;
            border-color: var(--gray-200);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .table tbody tr:hover {
            background-color: var(--gray-50);
        }
        
        /* Status Badges */
        .status-badge {
            font-size: var(--font-size-sm);
            padding: 0.425rem 0.85rem;
            border-radius: var(--border-radius);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        /* 모든 상태 배지 파스텔 톤 스타일 - Bootstrap 오버라이드 */
        .badge.status-completed,
        .badge.status-in-progress,
        .badge.status-payment-pending,
        .badge.status-prepaid {
            font-size: 0.8rem !important;
            padding: 0.3rem 0.6rem !important;
            font-weight: 600 !important;
            border-radius: 0.3rem !important;
            border: 1px solid rgba(0,0,0,0.1) !important;
            display: inline-block !important;
        }
        
        .badge.status-completed {
            background-color: #d4edda !important;  /* 연한 초록색 */
            color: #155724 !important;
        }
        
        .badge.status-in-progress {
            background-color: #fff3cd !important;  /* 연한 노란색 */
            color: #856404 !important;
        }
        
        .badge.status-payment-pending {
            background-color: #f8d7da !important;  /* 연한 빨간색 */
            color: #721c24 !important;
        }
        
        .badge.status-prepaid {
            background-color: #d1ecf1 !important;  /* 연한 청록색 */
            color: #0c5460 !important;
        }
        
        /* Amount Styling */
        .amount-cell {
            text-align: right !important;
            font-weight: 600;
            font-feature-settings: 'tnum';
        }
        
        .amount-outstanding {
            color: var(--danger-color);
        }
        
        .amount-completed {
            color: var(--success-color);
        }
        
        /* Action Buttons */
        .action-buttons .btn {
            margin: 0 0.125rem;
            padding: 0.375rem 0.75rem;
            border-radius: var(--border-radius-sm);
            transition: all 0.2s ease;
            font-size: var(--font-size-xs);
            font-weight: 500;
        }
        
        .action-buttons .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        /* Search Highlight */
        .search-highlight {
            background-color: #fef3c7;
            color: var(--gray-800);
        }
        
        /* Accordion Row Details */
        .row-details {
            background-color: var(--gray-50);
            padding: 1.5rem;
            border-left: 4px solid #17a2b8;
            border-radius: 0 var(--border-radius-lg) var(--border-radius-lg) 0;
        }
        
        .row-details .card {
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            border-radius: var(--border-radius-lg);
            background: white;
        }
        
        /* 아코디언 열린 행 강조 */
        .table tbody tr.accordion-open {
            background-color: #fff3cd !important;
            border-left: 4px solid #17a2b8;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .table tbody tr.accordion-open:hover {
            background-color: #fff3cd !important;
        }
        
        .row-details .card-body {
            padding: 2rem;
        }
        
        /* Accordion Header Info */
        .accordion-header-info {
            background-color: white !important;
            border: 1px solid var(--gray-200);
            border-left: 3px solid var(--primary-color);
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            padding: 1.25rem 1rem;
            min-height: auto;
            line-height: 1.5;
        }
        
        .accordion-header-info small {
            color: var(--gray-600);
            font-size: var(--font-size-sm);
        }
        
        .accordion-header-info .fw-bold {
            color: var(--gray-900);
            font-weight: 600;
        }
        
        /* Info Cards in Accordion - 깔끔한 디자인 */
        .info-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius-lg);
            padding: 1.2rem;
            height: 100%;
            min-height: 280px;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
        }
        
        /* 카드 그리드 레이아웃 */
        .card-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            flex: 1;
        }
        
        /* 컴팩트 아이템 스타일 개선 - 가로 정렬 및 구분 */
        .compact-item {
            display: flex;
            flex-direction: row;
            align-items: center;
            min-height: 42px;
            padding: 0.4rem 0;
            border-bottom: 1px solid var(--gray-100);
        }
        
        .compact-item:last-child {
            border-bottom: none;
        }
        
        .compact-item small {
            font-size: 0.8rem;
            color: var(--gray-500);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            min-width: 70px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .compact-item small::after {
            content: ':';
            margin-left: 0.2rem;
            color: var(--gray-400);
        }
        
        .compact-item > div {
            font-size: 0.9rem;
            color: var(--gray-800);
            line-height: 1.3;
            word-wrap: break-word;
            flex: 1;
            display: flex;
            align-items: center;
            padding-left: 0.5rem;
        }
        
        .info-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--gray-300);
        }
        
        .info-card h6 {
            margin-bottom: 1rem;
            font-weight: 600;
            font-size: var(--font-size-base);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .info-card h6 i {
            font-size: var(--font-size-sm);
        }
        
        .info-card h6.text-primary {
            color: var(--primary-color) !important;
        }
        
        .info-card h6.text-success {
            color: var(--success-color) !important;
        }
        
        .info-card h6.text-warning {
            color: var(--warning-color) !important;
        }
        
        .info-card h6.text-danger {
            color: var(--danger-color) !important;
        }
        
        /* Modal Styles */
        .modal-content {
            border-radius: var(--border-radius-xl);
            border: none;
            box-shadow: var(--shadow-xl);
        }

        /* Form check labels in modals */
        #newProjectModal .form-check-label {
            font-size: var(--font-size-sm);
        }

        /* Placeholder styles - make them lighter */
        #newProjectModal .form-control::placeholder,
        #newProjectModal .form-select::placeholder,
        #newProjectModal textarea::placeholder {
            color: #bbb !important;
            opacity: 0.7 !important;
        }

        /* Hide default date input calendar icon */
        #newProjectModal input[type="date"]::-webkit-calendar-picker-indicator {
            display: none;
            -webkit-appearance: none;
        }
        
        #newProjectModal input[type="date"]::-moz-calendar-picker-indicator {
            display: none;
        }
        
        .modal-header {
            background-color: #fafbfc;
            border-bottom: 1px solid var(--gray-200);
            border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
            padding: 1.5rem;
        }
        
        .modal-title {
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .modal-body {
            padding: 2rem;
        }
        
        .modal-footer {
            background-color: var(--gray-50);
            border-top: 1px solid var(--gray-200);
            border-radius: 0 0 var(--border-radius-xl) var(--border-radius-xl);
            padding: 1.5rem;
        }
        
        /* Project Detail View */
        .project-detail-view {
            font-size: var(--font-size-sm);
        }
        
        .project-detail-view .card {
            transition: all 0.2s ease;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
        }
        
        .project-detail-view .card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--gray-300);
        }
        
        .project-detail-view .card-header {
            background-color: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0 !important;
            padding: 1rem 1.5rem;
            font-weight: 600;
        }
        
        .project-detail-view .card-body {
            padding: 1.5rem;
        }
        
        /* Color Utilities */
        .text-primary { color: var(--primary-color) !important; }
        .text-success { color: var(--success-color) !important; }
        .text-warning { color: var(--warning-color) !important; }
        .text-danger { color: var(--danger-color) !important; }
        .text-info { color: var(--info-color) !important; }
        
        /* DataTables 페이지네이션 스타일 - 테두리 완전 제거 */
        .dataTables_wrapper .dataTables_paginate .paginate_button,
        .dataTables_wrapper .dataTables_paginate .paginate_button:link,
        .dataTables_wrapper .dataTables_paginate .paginate_button:visited,
        .dataTables_wrapper .dataTables_paginate .paginate_button:active {
            color: var(--gray-600) !important;
            background: transparent !important;
            border: none !important;
            border-radius: 0 !important;
            margin: 0 2px !important;
            padding: 0.25rem 0.5rem !important;
            text-decoration: none !important;
            box-shadow: none !important;
            font-size: 12px !important;
            font-weight: 400 !important;
            line-height: 1.2 !important;
            min-width: 24px !important;
            text-align: center !important;
            transition: none !important;
            outline: none !important;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover,
        .dataTables_wrapper .dataTables_paginate .paginate_button:focus {
            color: var(--gray-600) !important;
            background: transparent !important;
            border: none !important;
            transform: none !important;
            box-shadow: none !important;
            outline: none !important;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button.current,
        .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
            color: var(--gray-800) !important;
            background: var(--gray-200) !important;
            font-weight: 600 !important;
            border: 1px solid var(--gray-300) !important;
            border-radius: var(--border-radius) !important;
            text-decoration: none !important;
        }
        
        /* 부트스트랩 기본 페이지네이션 스타일 오버라이드 */
        .dataTables_wrapper .dataTables_paginate .paginate_button.page-link {
            color: var(--gray-600) !important;
            background-color: transparent !important;
            border: none !important;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button.page-link:hover {
            color: var(--gray-800) !important;
            background-color: var(--gray-100) !important;
            border-color: var(--gray-300) !important;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button.disabled,
        .dataTables_wrapper .dataTables_paginate .paginate_button.disabled:hover {
            color: var(--gray-400) !important;
            background: transparent !important;
            opacity: 0.5 !important;
            cursor: not-allowed !important;
            border: none !important;
        }
        
        /* Previous/Next 버튼도 동일하게 적용 */
        .dataTables_wrapper .dataTables_paginate .previous,
        .dataTables_wrapper .dataTables_paginate .next {
            color: var(--gray-600) !important;
            background: transparent !important;
            border: none !important;
        }
        
        /* 모든 페이지네이션 링크 스타일 강제 오버라이드 */
        .dataTables_wrapper .dataTables_paginate a {
            color: var(--gray-600) !important;
            background-color: transparent !important;
            border: none !important;
            text-decoration: none !important;
        }
        
        .dataTables_wrapper .dataTables_paginate a:hover {
            color: var(--gray-800) !important;
            background-color: var(--gray-100) !important;
            border: 1px solid var(--gray-300) !important;
            border-radius: var(--border-radius) !important;
        }
        
        .dataTables_wrapper .dataTables_paginate a.current {
            color: var(--gray-800) !important;
            background-color: var(--gray-200) !important;
            border: 1px solid var(--gray-300) !important;
            border-radius: var(--border-radius) !important;
            font-weight: 600 !important;
        }
        
        .dataTables_wrapper .dataTables_paginate .previous:hover,
        .dataTables_wrapper .dataTables_paginate .next:hover {
            color: var(--gray-600) !important;
            background: transparent !important;
            border: none !important;
        }
        
        /* DataTables 페이지네이션 컨테이너 정렬 */
        .dataTables_wrapper .dataTables_paginate {
            float: right !important;
            text-align: right !important;
            margin-top: 0 !important;
            padding-right: 1rem !important;
        }
        
        /* DataTables 하단 정보와 페이지네이션 높이 정렬 */
        .dataTables_wrapper .row:last-child {
            display: flex !important;
            align-items: center !important;
            margin-top: 1rem !important;
        }
        
        .dataTables_wrapper .dataTables_info {
            display: flex !important;
            align-items: center !important;
            margin-bottom: 0 !important;
        }
        
        .dataTables_wrapper .dataTables_paginate {
            display: flex !important;
            align-items: center !important;
            justify-content: flex-end !important;
        }
        
        .dataTables_wrapper .dataTables_filter input {
            border: 1px solid var(--gray-300) !important;
            border-radius: var(--border-radius) !important;
        }
        
        .dataTables_wrapper .dataTables_filter input:focus {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.2) !important;
        }
        
        /* 테이블 컨테이너 스타일 개선 */
        .dataTables_wrapper {
            width: 100% !important;
        }
        
        .dataTables_wrapper table {
            width: 100% !important;
            table-layout: fixed !important;
        }
        
        .dataTables_scrollBody {
            overflow: visible !important;
        }
        
        /* DataTables 정보 텍스트 스타일 */
        .dataTables_wrapper .dataTables_info {
            color: var(--gray-600) !important;
            font-size: var(--font-size-sm) !important;
            padding: 0.5rem 0 !important;
            margin-left: 1rem !important;
        }
        
        .dataTables_wrapper .dataTables_length {
            color: var(--gray-600) !important;
            font-size: var(--font-size-sm) !important;
            margin-left: 0.5rem !important;
            margin-top: 0.5rem !important;
        }
        
        /* DataTables 길이 선택 드롭다운 스타일 */
        .dataTables_wrapper .dataTables_length select {
            padding: 0.25rem 1.5rem 0.25rem 0.5rem !important;
            margin: 0 0.25rem !important;
            border: 1px solid var(--gray-300) !important;
            border-radius: var(--border-radius-sm) !important;
            background-color: white !important;
            font-size: var(--font-size-sm) !important;
            min-width: 60px !important;
        }
        
        
        
        /* Badge Colors */
        .badge.bg-success { background-color: var(--success-color) !important; }
        .badge.bg-warning { background-color: var(--warning-color) !important; }
        .badge.bg-primary { background-color: var(--primary-color) !important; }
        .badge.bg-danger { background-color: var(--danger-color) !important; }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .content-container {
                padding: 1.5rem;
            }
        }
        
        @media (max-width: 992px) {
            .all-info-container .col-lg-3 {
                flex: 0 0 50%;
                max-width: 50%;
                margin-bottom: 1rem;
            }
            
            .header h1 {
                font-size: var(--font-size-3xl);
            }
            
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 2rem 0;
                text-align: center;
            }
            
            .content-container {
                padding: 1rem;
            }
            
            .all-info-container .col-lg-3 {
                flex: 0 0 100%;
                max-width: 100%;
            }
            
            .filter-section {
                padding: 1rem;
            }
            
            .info-card {
                padding: 1rem;
            }
        }
        
        @media (max-width: 576px) {
            .header h1 {
                font-size: var(--font-size-2xl);
            }
            
            .compact-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }
            
            .compact-item small {
                min-width: auto;
                margin-right: 0;
            }
        /* Accordion Animations */
        .all-info-container {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Compact Card Specific Styles */
        .compact-card {
            padding: 1rem !important;
            margin-bottom: 0 !important;
            min-height: 140px;
        }

        .compact-card h6 {
            margin-bottom: 1rem !important;
            padding-bottom: 0.5rem !important;
            font-size: var(--font-size-sm);
            border-bottom: 1px solid var(--gray-200) !important;
        }

        .compact-item {
            margin-bottom: 0.5rem;
            display: flex;
            align-items: flex-start;
            min-height: 1.5rem;
        }

        .compact-item:last-child {
            margin-bottom: 0;
        }

        .compact-item small {
            font-size: var(--font-size-xs);
            font-weight: 500;
            line-height: 1.2;
            color: var(--gray-600);
            flex-shrink: 0;
            min-width: 70px;
            margin-right: 0.75rem;
        }

        .compact-item div {
            font-size: var(--font-size-sm);
            line-height: 1.3;
            word-break: break-word;
            flex: 1;
            color: var(--gray-800);
        }

        .compact-item .fw-bold {
            font-weight: 600;
            color: var(--gray-900);
        }
        
        /* Expanded Row */
        #projectsTable tbody tr.shown {
            background-color: var(--gray-50);
        }
        
        /* Loading Overlay - 기본적으로 숨김 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(3px);
            display: none !important;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.show {
            display: flex !important;
        }
        
        .loading-overlay .spinner-border {
            color: var(--primary-color) !important;
        }
        
        /* Form Input Styling */
        .form-control::placeholder {
            color: var(--gray-400) !important;
            opacity: 1;
        }
        
        .form-control::-webkit-input-placeholder {
            color: var(--gray-400) !important;
            opacity: 1;
        }
        
        .form-control::-moz-placeholder {
            color: var(--gray-400) !important;
            opacity: 1;
        }
        
        .form-control:-ms-input-placeholder {
            color: var(--gray-400) !important;
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- 로딩 오버레이 - 숨김 처리 -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none !important;">
        <div class="text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
            <p class="mt-2">데이터를 불러오는 중...</p>
        </div>
    </div>

    <!-- 헤더 -->
    <div class="header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center justify-content-start" style="padding-left: 2rem; height: 120px; overflow: hidden;">
                        <img src="/data/아이티글로벌-추가최종2-(png)_0000_Vector-Smart-Object.png" alt="IT글로벌 로고" class="logo">
                        <div class="ms-3" style="display: flex; align-items: center; height: 120px;">
                            <p class="mb-0 logo-subtitle">냉난방기 설치공사 통합 관리 시스템</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-outline-success me-2" id="refreshProjectBtn" onclick="refreshProjectData()">
                        <i class="fas fa-sync-alt me-1"></i>새로고침
                    </button>
                    <button class="btn btn-light me-3" onclick="openNewProjectModal()">
                        <i class="fas fa-plus me-2"></i>새 프로젝트 등록
                    </button>
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="fas fa-tachometer-alt me-2"></i>대시보드
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- 알림 영역 -->
        <div id="alertContainer"></div>

        <div class="content-container">
            <div class="row mb-4">
                <div class="col-12">
                    <h4 class="mb-0">프로젝트 관리</h4>
                </div>
            </div>

            <!-- 필터 섹션 (고정) -->
            <div class="filter-section-sticky">
                <div class="filter-section">
                    <div class="row">
                        <div class="col-md-1">
                            <label for="companyFilter" class="form-label">사업자</label>
                            <select class="form-select" id="companyFilter">
                                <option value="">전체</option>
                                <option value="글로벌">글로벌</option>
                                <option value="글로벌그룹">글로벌그룹</option>
                            </select>
                        </div>
                        
                        <div class="col-md-1">
                            <label for="statusFilter" class="form-label">상태</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">전체</option>
                                <option value="completed">공사완료</option>
                                <option value="in-progress">공사진행중</option>
                                <option value="payment-pending">수금대기</option>
                                <option value="prepaid">선입금</option>
                            </select>
                        </div>
                        
                        <div class="col-md-1">
                            <label for="managerFilter" class="form-label">담당자</label>
                            <select class="form-select" id="managerFilter">
                                <option value="">전체</option>
                                <!-- 동적으로 담당자 목록이 로드됩니다 -->
                            </select>
                        </div>
                        
                        <div class="col-md-1">
                            <label for="outstandingFilter" class="form-label">미수금</label>
                            <select class="form-select" id="outstandingFilter">
                                <option value="">전체</option>
                                <option value="collected">수금 완료</option>
                                <option value="outstanding">미수금 있음</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="searchInput" class="form-label">키워드 검색</label>
                            <input type="text" class="form-control" id="searchInput" 
                                   placeholder="프로젝트 코드, 주소, 거래처 등...">
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button class="btn btn-secondary" onclick="applyFilters()" title="검색">
                                    <i class="fas fa-search me-1"></i>검색
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearFilters()" title="초기화">
                                    <i class="fas fa-times me-1"></i>초기화
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 테이블 섹션 -->
            <div class="table-section">
                <div class="table-wrapper">
                    <table class="table table-hover" id="projectsTable">
                        <thead>
                            <tr>
                                <th style="width: 8%;">프로젝트 코드</th>
                                <th style="width: 6%;">담당자</th>
                                <th style="width: 8%;">거래처</th>
                                <th style="width: 27%;">현장 주소</th>
                                <th style="width: 21%;">공사 내용</th>
                                <th style="width: 8%;">공사 시작</th>
                                <th style="width: 8%;">공사 종료</th>
                                <th style="width: 8%;">총액</th>
                                <th style="width: 8%;">미수금</th>
                                <th style="width: 8%;">상태</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- JavaScript로 동적 생성 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <!-- 프로젝트 보기 모달 -->
    <div class="modal fade" id="viewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">프로젝트 상세 정보</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="viewProjectInfo">
                        <!-- 프로젝트 정보 표시 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-warning" onclick="openEditFromView()">편집</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 프로젝트 편집 모달 -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">프로젝트 편집</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <iframe id="editFrame" src="" style="width: 100%; height: 500px; border: none;"></iframe>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 새 프로젝트 등록 모달 -->
    <div class="modal fade" id="newProjectModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content" style="border-radius: var(--border-radius-xl); border: none; box-shadow: var(--shadow-xl);">
                <div class="modal-header" style="background-color: #fafbfc; color: var(--gray-900); border-bottom: 1px solid var(--gray-200); border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0; padding: 1.5rem;">
                    <h5 class="modal-title" style="font-weight: 600; color: var(--gray-900); display: flex; align-items: center;">
                        <i class="fas fa-plus-circle me-2" style="color: #17a2b8;"></i>
                        <span>새 프로젝트 등록</span>
                        <span class="badge ms-2" style="background-color: #d4edda; color: #155724; font-size: var(--font-size-xs); font-weight: 600; border: 1px solid #c3e6cb;">자동 코드 생성</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" style="opacity: 0.8;"></button>
                </div>
                <div class="modal-body" style="background-color: var(--gray-50); padding: 2rem;">
                    <!-- 모달 전용 알림 컨테이너 -->
                    <div id="modalAlertContainer"></div>
                    
                    <form id="newProjectForm">
                        <!-- 기본 정보 섹션 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card" style="border: 1px solid var(--gray-200); box-shadow: var(--shadow-sm); border-radius: var(--border-radius-lg); background: white;">
                                    <div class="card-header" style="background-color: #fafbfc; border-bottom: 1px solid var(--gray-200); border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; padding: 1rem 1.5rem;">
                                        <h6 class="mb-0" style="color: var(--gray-900); font-weight: 600; font-size: var(--font-size-base); display: flex; align-items: center; gap: 0.5rem;">
                                            <i class="fas fa-info-circle" style="color: #2196f3; font-size: var(--font-size-sm);"></i>기본 정보
                                        </h6>
                                    </div>
                                    <div class="card-body" style="padding: 1.5rem;">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label" style="font-weight: 500; color: var(--gray-700); font-size: var(--font-size-sm); margin-bottom: 0.5rem;">
                                                    사업자 <span class="text-danger">*</span>
                                                </label>
                                                <select class="form-select" id="company" name="사업자" required style="border-radius: var(--border-radius); border: 1px solid var(--gray-300); font-size: var(--font-size-sm); height: 38px; padding: 0.5rem 0.75rem; transition: all 0.2s ease;">
                                                    <option value="">사업자 선택</option>
                                                    <option value="글로벌">글로벌</option>
                                                    <option value="글로벌그룹">글로벌그룹</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label" style="font-weight: 500; color: var(--gray-700); font-size: var(--font-size-sm); margin-bottom: 0.5rem;">
                                                    담당자 <span class="text-danger">*</span>
                                                </label>
                                                <select class="form-select" id="owner" name="담당자" required style="border-radius: var(--border-radius); border: 1px solid var(--gray-300); font-size: var(--font-size-sm); height: 38px; padding: 0.5rem 0.75rem; transition: all 0.2s ease;">
                                                    <option value="">담당자 선택</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label" style="font-weight: 500; color: var(--gray-700); font-size: var(--font-size-sm); margin-bottom: 0.5rem;">
                                                    생성될 프로젝트 코드
                                                </label>
                                                <div class="form-control text-center fw-bold" id="generated-code" style="background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; border-radius: var(--border-radius); font-size: var(--font-size-sm); height: 38px; display: flex; align-items: center; justify-content: center;">
                                                    사업자와 담당자를 선택하세요
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 현장 정보 섹션 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card" style="border: 1px solid var(--gray-200); box-shadow: var(--shadow-sm); border-radius: var(--border-radius-lg); background: white;">
                                    <div class="card-header" style="background-color: #fafbfc; border-bottom: 1px solid var(--gray-200); border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; padding: 1rem 1.5rem;">
                                        <h6 class="mb-0" style="color: var(--gray-900); font-weight: 600; font-size: var(--font-size-base); display: flex; align-items: center; gap: 0.5rem;">
                                            <i class="fas fa-map-marker-alt" style="color: var(--success-color); font-size: var(--font-size-sm);"></i>현장 정보
                                        </h6>
                                    </div>
                                    <div class="card-body" style="padding: 1.5rem;">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label" style="font-weight: 500; color: var(--gray-700); font-size: var(--font-size-sm); margin-bottom: 0.5rem;">거래처 <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="client" name="거래처" required list="clientList" autocomplete="off" placeholder="거래처명" style="border-radius: var(--border-radius); border: 1px solid var(--gray-300); font-size: var(--font-size-sm); height: 38px; padding: 0.5rem 0.75rem; transition: all 0.2s ease;">
                                                <datalist id="clientList">
                                                    <!-- 동적으로 채워짐 -->
                                                </datalist>
                                            </div>
                                            <div class="col-md-8">
                                                <label class="form-label" style="font-weight: 500; color: var(--gray-700); font-size: var(--font-size-sm); margin-bottom: 0.5rem;">공사 구분 <small class="text-muted">(최대 2개 선택 가능)</small></label>
                                                <div class="border rounded p-3" style="background-color: #fafafa;">
                                                    <div class="row g-3">
                                                        <div class="col-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input work-category-checkbox" type="checkbox" value="설치" id="work-cat-1">
                                                                <label class="form-check-label fw-normal" for="work-cat-1">설치</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input work-category-checkbox" type="checkbox" value="이전" id="work-cat-2">
                                                                <label class="form-check-label fw-normal" for="work-cat-2">이전</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input work-category-checkbox" type="checkbox" value="세척" id="work-cat-3">
                                                                <label class="form-check-label fw-normal" for="work-cat-3">세척</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input work-category-checkbox" type="checkbox" value="철거" id="work-cat-4">
                                                                <label class="form-check-label fw-normal" for="work-cat-4">철거</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input work-category-checkbox" type="checkbox" value="A/S" id="work-cat-5">
                                                                <label class="form-check-label fw-normal" for="work-cat-5">A/S</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input work-category-checkbox" type="checkbox" value="판매" id="work-cat-6">
                                                                <label class="form-check-label fw-normal" for="work-cat-6">판매</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input work-category-checkbox" type="checkbox" value="매입" id="work-cat-7">
                                                                <label class="form-check-label fw-normal" for="work-cat-7">매입</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input work-category-checkbox" type="checkbox" value="렌탈" id="work-cat-8">
                                                                <label class="form-check-label fw-normal" for="work-cat-8">렌탈</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <input type="hidden" id="work-category" name="공사 구분" value="">
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <label class="form-label" style="font-weight: 500; color: var(--gray-700); font-size: var(--font-size-sm); margin-bottom: 0.5rem;">현장 주소 <span class="text-danger">*</span> <small class="text-muted">(도로명 주소만 입력해주세요)</small></label>
                                                <textarea class="form-control" id="address" name="현장 주소" rows="2" required placeholder="강남구 테헤란로 123 여삼빌딩 5층 505호 OO의원" style="border-radius: var(--border-radius); border: 1px solid var(--gray-300); font-size: var(--font-size-sm); padding: 0.5rem 0.75rem; transition: all 0.2s ease; resize: vertical;"></textarea>
                                                <div class="form-text text-info d-none" id="address-info">
                                                    <i class="fas fa-info-circle me-1"></i>주소가 자동으로 정리되었습니다.
                                                </div>
                                                <div class="form-text text-warning d-none" id="address-warning">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>지번 주소가 감지되었습니다. 도로명 주소로 변경해주세요.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 기술 정보 섹션 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card" style="border: 1px solid var(--gray-200); box-shadow: var(--shadow-sm); border-radius: var(--border-radius-lg); background: white;">
                                    <div class="card-header" style="background-color: #fafbfc; border-bottom: 1px solid var(--gray-200); border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; padding: 1rem 1.5rem;">
                                        <h6 class="mb-0" style="color: var(--gray-900); font-weight: 600; font-size: var(--font-size-base); display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-tools" style="color: #9c27b0; font-size: var(--font-size-sm);"></i>시공 상세</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label" style="font-weight: 500; color: var(--gray-700); font-size: var(--font-size-sm); margin-bottom: 0.5rem;">기계 분류 <small class="text-muted">(최대 2개 선택 가능)</small></label>
                                                <div class="border rounded p-3" style="background-color: #fafafa; min-height: 80px;">
                                                    <div class="row g-3">
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input machine-category-checkbox" type="checkbox" value="신품" id="machine-cat-1">
                                                                <label class="form-check-label fw-normal" for="machine-cat-1">신품</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input machine-category-checkbox" type="checkbox" value="중고" id="machine-cat-2">
                                                                <label class="form-check-label fw-normal" for="machine-cat-2">중고</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input machine-category-checkbox" type="checkbox" value="기존제품" id="machine-cat-3">
                                                                <label class="form-check-label fw-normal" for="machine-cat-3">기존제품</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input machine-category-checkbox" type="checkbox" value="기타" id="machine-cat-4">
                                                                <label class="form-check-label fw-normal" for="machine-cat-4">기타</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label" style="font-weight: 500; color: var(--gray-700); font-size: var(--font-size-sm); margin-bottom: 0.5rem;">브랜드 <small class="text-muted">(최대 2개 선택 가능)</small></label>
                                                <div class="border rounded p-3" style="background-color: #fafafa; min-height: 80px;">
                                                    <div class="row g-3">
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input brand-category-checkbox" type="checkbox" value="LG" id="brand-cat-1">
                                                                <label class="form-check-label fw-normal" for="brand-cat-1">LG</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input brand-category-checkbox" type="checkbox" value="삼성" id="brand-cat-2">
                                                                <label class="form-check-label fw-normal" for="brand-cat-2">삼성</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input brand-category-checkbox" type="checkbox" value="캐리어" id="brand-cat-3">
                                                                <label class="form-check-label fw-normal" for="brand-cat-3">캐리어</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input brand-category-checkbox" type="checkbox" value="FCU" id="brand-cat-4">
                                                                <label class="form-check-label fw-normal" for="brand-cat-4">FCU</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input brand-category-checkbox" type="checkbox" value="덕트" id="brand-cat-5">
                                                                <label class="form-check-label fw-normal" for="brand-cat-5">덕트</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input brand-category-checkbox" type="checkbox" value="기타" id="brand-cat-6">
                                                                <label class="form-check-label fw-normal" for="brand-cat-6">기타</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label" style="font-weight: 500; color: var(--gray-700); font-size: var(--font-size-sm); margin-bottom: 0.5rem;">도급 구분 <small class="text-muted">(최대 2개 선택 가능)</small></label>
                                                <div class="border rounded p-3" style="background-color: #fafafa; min-height: 80px;">
                                                    <div class="row g-3">
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input contract-category-checkbox" type="checkbox" value="외주" id="contract-cat-1">
                                                                <label class="form-check-label fw-normal" for="contract-cat-1">외주</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input contract-category-checkbox" type="checkbox" value="내부" id="contract-cat-2">
                                                                <label class="form-check-label fw-normal" for="contract-cat-2">내부</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input contract-category-checkbox" type="checkbox" value="일당" id="contract-cat-3">
                                                                <label class="form-check-label fw-normal" for="contract-cat-3">일당</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input contract-category-checkbox" type="checkbox" value="기타" id="contract-cat-4">
                                                                <label class="form-check-label fw-normal" for="contract-cat-4">기타</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-4">
                                                <label class="form-label" style="font-weight: 500; color: var(--gray-700); font-size: var(--font-size-sm); margin-bottom: 0.5rem;">시공자</label>
                                                <input type="text" class="form-control" id="constructor" name="시공자" placeholder="시공자명" style="border-radius: var(--border-radius); border: 1px solid var(--gray-300); font-size: var(--font-size-sm); height: 38px; padding: 0.5rem 0.75rem; transition: all 0.2s ease;">
                                            </div>
                                            <div class="col-md-8">
                                                <label class="form-label" style="font-weight: 500; color: var(--gray-700); font-size: var(--font-size-sm); margin-bottom: 0.5rem;">공사 내용</label>
                                                <textarea class="form-control" id="work-content" name="공사 내용" rows="1" placeholder="냉난방기 설치, 덕트 공사 등" style="border-radius: var(--border-radius); border: 1px solid var(--gray-300); font-size: var(--font-size-sm); padding: 0.5rem 0.75rem; transition: all 0.2s ease; resize: vertical;"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 일정 정보 섹션 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card" style="border: 1px solid var(--gray-200); box-shadow: var(--shadow-sm); border-radius: var(--border-radius-lg); background: white;">
                                    <div class="card-header" style="background-color: #fafbfc; border-bottom: 1px solid var(--gray-200); border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; padding: 1rem 1.5rem;">
                                        <h6 class="mb-0" style="color: var(--gray-900); font-weight: 600; font-size: var(--font-size-base); display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-calendar" style="color: #ff9800; font-size: var(--font-size-sm);"></i>일정 정보</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label" style="font-weight: 500; color: var(--gray-700); font-size: var(--font-size-sm); margin-bottom: 0.5rem;">공사 시작</label>
                                                <div class="input-group">
                                                    <input type="date" class="form-control date-input" id="start-date" name="공사 시작" onkeydown="return false" onpaste="return false" onchange="handleStartDateChange()" style="cursor: pointer; border-radius: var(--border-radius) 0 0 var(--border-radius); border: 1px solid var(--gray-300); border-right: none; font-size: var(--font-size-sm); height: 38px; padding: 0.5rem 0.75rem; transition: all 0.2s ease;">
                                                    <span class="input-group-text calendar-icon" style="cursor: pointer; background-color: #f8f9fa; border: 1px solid var(--gray-300); border-left: none; color: #6c757d; border-radius: 0 var(--border-radius) var(--border-radius) 0;">
                                                        <i class="fas fa-calendar-alt"></i>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label" style="font-weight: 500; color: var(--gray-700); font-size: var(--font-size-sm); margin-bottom: 0.5rem;">공사 종료</label>
                                                <div class="input-group">
                                                    <input type="date" class="form-control date-input" id="end-date" name="공사 종료" onkeydown="return false" onpaste="return false" style="cursor: pointer; border-radius: var(--border-radius) 0 0 var(--border-radius); border: 1px solid var(--gray-300); border-right: none; font-size: var(--font-size-sm); height: 38px; padding: 0.5rem 0.75rem; transition: all 0.2s ease;">
                                                    <span class="input-group-text calendar-icon" style="cursor: pointer; background-color: #f8f9fa; border: 1px solid var(--gray-300); border-left: none; color: #6c757d; border-radius: 0 var(--border-radius) var(--border-radius) 0;">
                                                        <i class="fas fa-calendar-alt"></i>
                                                    </span>
                                                </div>
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input" type="checkbox" id="same-date-check">
                                                    <label class="form-check-label" for="same-date-check">
                                                        <small class="text-muted">시작일과 동일</small>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 담당자 정보 섹션 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card" style="border: 1px solid var(--gray-200); box-shadow: var(--shadow-sm); border-radius: var(--border-radius-lg); background: white;">
                                    <div class="card-header" style="background-color: #fafbfc; border-bottom: 1px solid var(--gray-200); border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; padding: 1rem 1.5rem;">
                                        <h6 class="mb-0" style="color: var(--gray-900); font-weight: 600; font-size: var(--font-size-base); display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-user" style="color: #00bcd4; font-size: var(--font-size-sm);"></i>담당자 정보</h6>
                                    </div>
                                    <div class="card-body" style="padding: 1.5rem;">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label" style="font-weight: 500; color: var(--gray-700); font-size: var(--font-size-sm); margin-bottom: 0.5rem;">현장 담당자</label>
                                                <input type="text" class="form-control" id="site-manager" name="현장 담당자" placeholder="현장 담당자명" style="border-radius: var(--border-radius); border: 1px solid var(--gray-300); font-size: var(--font-size-sm); height: 38px; padding: 0.5rem 0.75rem; transition: all 0.2s ease;">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label" style="font-weight: 500; color: var(--text-primary);">담당자 연락처</label>
                                                <input type="tel" class="form-control" id="manager-phone" name="담당자 연락처" placeholder="010-0000-0000" style="border-radius: var(--border-radius); border: 1px solid var(--gray-300); font-size: var(--font-size-sm); height: 38px; padding: 0.5rem 0.75rem; transition: all 0.2s ease;">
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <label class="form-label" style="font-weight: 500; color: var(--text-primary);">담당자 이메일</label>
                                                <input type="email" class="form-control" id="manager-email" name="담당자 이메일" placeholder="example@email.com" style="border-radius: var(--border-radius); border: 1px solid var(--gray-300); font-size: var(--font-size-sm); height: 38px; padding: 0.5rem 0.75rem; transition: all 0.2s ease;">
                                                <div class="form-text text-danger d-none" id="email-error">
                                                    <i class="fas fa-exclamation-circle me-1"></i>올바른 이메일 형식을 입력해주세요 (예: user@example.com)
                                                </div>
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input" type="checkbox" id="email-unknown-check">
                                                    <label class="form-check-label" for="email-unknown-check">
                                                        <small class="text-muted">이메일 확인 불가</small>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 금액 정보 섹션 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card" style="border: 1px solid var(--gray-200); box-shadow: var(--shadow-sm); border-radius: var(--border-radius-lg); background: white;">
                                    <div class="card-header" style="background-color: #fafbfc; border-bottom: 1px solid var(--gray-200); border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; padding: 1rem 1.5rem;">
                                        <h6 class="mb-0" style="color: var(--gray-900); font-weight: 600; font-size: var(--font-size-base); display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-won" style="color: var(--warning-color); font-size: var(--font-size-sm);"></i>금액 정보</h6>
                                    </div>
                                    <div class="card-body" style="padding: 1.5rem;">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label" style="font-weight: 500; color: var(--text-primary);">총액1 <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="total-amount-display" required placeholder="1,500,000" maxlength="15" style="border-radius: var(--border-radius); border: 1px solid var(--gray-300); font-size: var(--font-size-sm); height: 38px; padding: 0.5rem 0.75rem; transition: all 0.2s ease;">
                                                <input type="hidden" id="total-amount" name="총액1" value="0">
                                                
                                                <!-- 금액 버튼들 -->
                                                <div class="mt-3">
                                                    <div class="row g-2">
                                                        <div class="col-4">
                                                            <button type="button" class="btn btn-outline-primary btn-sm w-100 amount-btn" data-amount="100000000" style="border-color: #17a2b8; color: #17a2b8; background-color: transparent; transition: all 0.2s ease;" onmouseover="this.style.backgroundColor='#d1ecf1'" onmouseout="this.style.backgroundColor='transparent'">일억원</button>
                                                        </div>
                                                        <div class="col-4">
                                                            <button type="button" class="btn btn-outline-primary btn-sm w-100 amount-btn" data-amount="10000000" style="border-color: #17a2b8; color: #17a2b8; background-color: transparent; transition: all 0.2s ease;" onmouseover="this.style.backgroundColor='#d1ecf1'" onmouseout="this.style.backgroundColor='transparent'">천만원</button>
                                                        </div>
                                                        <div class="col-4">
                                                            <button type="button" class="btn btn-outline-primary btn-sm w-100 amount-btn" data-amount="1000000" style="border-color: #17a2b8; color: #17a2b8; background-color: transparent; transition: all 0.2s ease;" onmouseover="this.style.backgroundColor='#d1ecf1'" onmouseout="this.style.backgroundColor='transparent'">백만원</button>
                                                        </div>
                                                        <div class="col-4">
                                                            <button type="button" class="btn btn-outline-primary btn-sm w-100 amount-btn" data-amount="100000" style="border-color: #17a2b8; color: #17a2b8; background-color: transparent; transition: all 0.2s ease;" onmouseover="this.style.backgroundColor='#d1ecf1'" onmouseout="this.style.backgroundColor='transparent'">십만원</button>
                                                        </div>
                                                        <div class="col-4">
                                                            <button type="button" class="btn btn-outline-primary btn-sm w-100 amount-btn" data-amount="50000" style="border-color: #17a2b8; color: #17a2b8; background-color: transparent; transition: all 0.2s ease;" onmouseover="this.style.backgroundColor='#d1ecf1'" onmouseout="this.style.backgroundColor='transparent'">오만원</button>
                                                        </div>
                                                        <div class="col-4">
                                                            <button type="button" class="btn btn-outline-secondary btn-sm w-100" id="amount-reset-btn" style="border-color: #dc3545; color: #dc3545; background-color: transparent; transition: all 0.2s ease;" onmouseover="this.style.backgroundColor='#f8d7da'" onmouseout="this.style.backgroundColor='transparent'">초기화</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label" style="font-weight: 500; color: var(--text-primary);">부가세 포함 여부</label>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="vat-included" name="부가세 포함" checked>
                                                        <label class="form-check-label" for="vat-included" style="font-weight: 400;">부가세 포함</label>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="form-label" style="font-weight: 500; color: var(--text-primary);">총액2</label>
                                                    <div class="p-2 rounded" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 1px solid #dee2e6;">
                                                        <span id="display-amount" class="fw-bold" style="color: #0c5460; font-size: 1.1rem;">0원</span>
                                                        <span id="amount-korean" class="text-muted ms-2">(금 영원정)</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 문서 정보 섹션 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card" style="border: 1px solid var(--gray-200); box-shadow: var(--shadow-sm); border-radius: var(--border-radius-lg); background: white;">
                                    <div class="card-header" style="background-color: #fafbfc; border-bottom: 1px solid var(--gray-200); border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; padding: 1rem 1.5rem;">
                                        <h6 class="mb-0" style="color: var(--gray-900); font-weight: 600; font-size: var(--font-size-base); display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-folder" style="color: #e91e63; font-size: var(--font-size-sm);"></i>문서 정보</h6>
                                    </div>
                                    <div class="card-body" style="padding: 1.5rem;">
                                        <div class="row">
                                            <div class="col-12">
                                                <label class="form-label" style="font-weight: 500; color: var(--gray-700); font-size: var(--font-size-sm); margin-bottom: 0.5rem;">견적서 및 계약서 폴더 경로</label>
                                                <input type="text" class="form-control" id="document-path" name="견적서 및 계약서 폴더 경로" placeholder="C:\Documents\Project\2025\프로젝트명" style="border-radius: var(--border-radius); border: 1px solid var(--gray-300); font-size: var(--font-size-sm); height: 38px; padding: 0.5rem 0.75rem; transition: all 0.2s ease;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="background-color: var(--gray-50); border-top: 1px solid var(--gray-200); border-radius: 0 0 var(--border-radius-xl) var(--border-radius-xl); padding: 1.5rem;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: var(--border-radius); font-weight: 500; padding: 0.625rem 1.5rem; transition: all 0.2s ease; background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24;" onmouseover="this.style.backgroundColor='#f5c6cb'; this.style.borderColor='#f1b0b7'" onmouseout="this.style.backgroundColor='#f8d7da'; this.style.borderColor='#f5c6cb'">취소</button>
                    <button type="submit" class="btn btn-primary" form="newProjectForm" id="submit-new-project" style="background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: var(--border-radius); font-weight: 500; padding: 0.625rem 1.5rem; transition: all 0.2s ease; color: #155724;" onmouseover="this.style.backgroundColor='#c3e6cb'; this.style.borderColor='#b3d7c1'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 6px rgba(21, 87, 36, 0.2)'" onmouseout="this.style.backgroundColor='#d4edda'; this.style.borderColor='#c3e6cb'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <span class="spinner-border spinner-border-sm me-2 d-none" id="submit-loading"></span>
                        프로젝트 등록
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- DataTables FixedHeader JS -->
    <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

    <script>
        // 전역 변수
        let projectsData = [];
        let dataTable = null;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // 스피너 즉시 숨김 처리
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none !important';
                loadingOverlay.classList.remove('show');
            }
            
            initializePage();
        });

        // 페이지 초기화
        async function initializePage() {
            showLoading(true);
            
            try {
                await loadProjectsData();
                loadManagerFilter(); // 담당자 필터 로드
                initializeDataTable();
                setupEventListeners();

                // URL 파라미터 확인하여 새 프로젝트 모달 자동 열기
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('openNewModal') === 'true') {
                    setTimeout(() => {
                        openNewProjectModal();
                        // URL에서 파라미터 제거
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }, 500);
                }
            } catch (error) {
                console.error('페이지 초기화 오류:', error);
                showAlert('데이터를 불러오는데 실패했습니다.', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // 프로젝트 데이터 로드
        async function loadProjectsData() {
            try {
                console.log('데이터 로드 시작...');
                // 캐시 무시하고 최신 데이터 로드
                const timestamp = new Date().getTime();
                const response = await fetch(`/api/projects/list?t=${timestamp}`, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                console.log('API 응답 상태:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('데이터 파싱 완료, 타입:', typeof data, '길이:', Array.isArray(data) ? data.length : 'not array');
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                projectsData = data;
                console.log('프로젝트 데이터 로드됨:', projectsData.length, '건');
                
                // 컬럼명과 샘플 데이터 디버깅
                if (projectsData.length > 0) {
                    console.log('사용 가능한 컬럼명:', Object.keys(projectsData[0]));
                    
                    // S열과 W열 데이터 확인
                    const firstRow = projectsData[0];
                    console.log('S열 관련 데이터:', {
                        '총액2': firstRow['총액2'],
                        '총액 2': firstRow['총액 2'],
                        'S': firstRow['S']
                    });
                    console.log('W열 관련 데이터:', {
                        '미수금W': firstRow['미수금W'],
                        '미수금 W': firstRow['미수금 W'],
                        'W': firstRow['W'],
                        '미수금': firstRow['미수금']
                    });
                }
                
            } catch (error) {
                console.error('프로젝트 데이터 로드 오류:', error);
                console.error('오류 세부사항:', error.message);
                console.error('스택 트레이스:', error.stack);
                throw error;
            }
        }

        // 담당자 필터 로드
        function loadManagerFilter() {
            if (!projectsData || projectsData.length === 0) return;
            
            // 담당자 목록 추출
            const managers = new Set();
            projectsData.forEach(project => {
                const manager = project['담당자'];
                if (manager && manager.toString().trim()) {
                    managers.add(manager.toString().trim());
                }
            });
            
            // 담당자 드롭다운 업데이트
            const managerSelect = document.getElementById('managerFilter');
            managerSelect.innerHTML = '<option value="">전체</option>';
            
            // 담당자 목록을 정렬하여 추가
            Array.from(managers).sort().forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                managerSelect.appendChild(option);
            });
            
            console.log(`담당자 필터 로드 완료: ${managers.size}명`);
        }


        // DataTable 초기화
        function initializeDataTable() {
            if (dataTable) {
                dataTable.destroy();
            }
            
            dataTable = $('#projectsTable').DataTable({
                data: projectsData,
                columns: [
                    { data: '프로젝트 코드', width: '8%' },
                    { data: '담당자', width: '6%' },
                    { data: '거래처', width: '8%' },
                    { 
                        data: '현장 주소',
                        width: '27%'
                    },
                    { 
                        data: '공사 내용',
                        width: '21%'
                    },
                    { 
                        data: '공사 시작',
                        width: '8%',
                        render: function(data) {
                            return data ? formatDate(data) : '';
                        }
                    },
                    { 
                        data: '공사 종료',
                        width: '8%',
                        render: function(data) {
                            return data ? formatDate(data) : '<span class="text-muted">-</span>';
                        }
                    },
                    { 
                        data: null, // S열 총액2 동적 처리
                        className: 'amount-cell',
                        width: '8%',
                        render: function(data, type, row) {
                            // 다양한 컬럼명 시도 (API 응답 기준)
                            const totalAmount = row['총액 2'] || row['총액2'] || row['S'] || row['총액'] || 0;
                            const numValue = parseFloat(totalAmount) || 0;
                            console.log('총액 데이터:', totalAmount, '변환값:', numValue); // 디버깅용
                            return numValue > 0 ? formatCurrency(numValue) : '-';
                        }
                    },
                    { 
                        data: null, // W열 미수금 동적 처리
                        className: 'amount-cell',
                        width: '8%',
                        render: function(data, type, row) {
                            // 다양한 컬럼명으로 W열 미수금 데이터 찾기
                            const outstandingData = row['미수금'] || row['미수금W'] || row['미수금 W'] || row['W'] || 0;
                            const outstandingAmount = parseFloat(outstandingData) || 0;
                            
                            console.log('미수금 데이터:', outstandingData, '변환값:', outstandingAmount); // 디버깅용
                            
                            // 미수금이 0이면 수금 완료로 표시
                            if (outstandingAmount === 0) {
                                return '<span class="text-success">수금 완료</span>';
                            } else if (outstandingAmount > 0) {
                                return `<span class="amount-outstanding">${formatCurrency(outstandingAmount)}</span>`;
                            } else {
                                return '<span class="text-muted">-</span>';
                            }
                        }
                    },
                    { 
                        data: null,
                        width: '8%',
                        render: function(data, type, row) {
                            return getStatusBadge(row);
                        }
                    }
                ],
                // fixedHeader 제거 - CSS sticky 사용
                columnDefs: [
                    {
                        targets: 0, // 프로젝트 코드 컬럼 (첫 번째 컬럼)
                        type: 'num', // 숫자 타입으로 정렬
                        render: function(data, type, row) {
                            if (type === 'sort') {
                                // 정렬할 때는 숫자 부분만 추출하여 정수로 반환
                                return parseInt(data?.replace(/[^0-9]/g, '') || '0');
                            }
                            // 프로젝트 코드 뱃지 적용
                            return `<span class="fw-bold" style="font-size: 1rem;">${createProjectBadge(data)}</span>`;
                        }
                    },
                    {
                        targets: 1, // 담당자 컬럼
                        render: function(data, type, row) {
                            if (type === 'sort') return data || '';
                            return createManagerBadge(data);
                        }
                    },
                    {
                        targets: 2, // 거래처 컬럼 (사업자)
                        render: function(data, type, row) {
                            if (type === 'sort') return data || '';
                            return createCompanyBadge(data);
                        }
                    }
                ],
                order: [[0, 'desc']], // 프로젝트 코드 기준 내림차순
                pageLength: 15,
                lengthMenu: [10, 15, 25, 50, 100],
                responsive: true,
                autoWidth: false,
                scrollX: false,
                language: {
                    "emptyTable": "데이터가 없습니다.",
                    "info": "_START_번째부터 _END_번째까지 (전체 _TOTAL_개)",
                    "infoEmpty": "0개 데이터",
                    "infoFiltered": "(전체 _MAX_개에서 필터링됨)",
                    "lengthMenu": "_MENU_개씩 보기",
                    "loadingRecords": "로딩 중...",
                    "processing": "처리 중...",
                    "search": "검색:",
                    "zeroRecords": "검색 결과가 없습니다.",
                    "paginate": {
                        "first": "처음",
                        "last": "마지막", 
                        "next": "다음",
                        "previous": "이전"
                    },
                    "aria": {
                        "sortAscending": ": 오름차순 정렬",
                        "sortDescending": ": 내림차순 정렬"
                    }
                },
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6">>' +
                     '<"row"<"col-sm-12"tr>>' +
                     '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                drawCallback: function() {
                    // 테이블 그려진 후 스타일 적용
                    $('[data-bs-toggle="tooltip"]').tooltip();
                    
                    // 행 클릭 이벤트 추가
                    setupRowClickEvents();
                }
            });
        }

        // 행 클릭 이벤트 설정
        function setupRowClickEvents() {
            $('#projectsTable tbody tr').off('click').on('click', function(e) {
                // 버튼 클릭 시에는 행 이벤트 무시
                if ($(e.target).closest('.btn, button').length > 0) {
                    return;
                }
                
                const tr = $(this);
                const row = dataTable.row(tr);
                
                if (row.child.isShown()) {
                    // 이미 확장된 상태라면 닫기
                    row.child.hide();
                    tr.removeClass('shown accordion-open');
                    console.log('아코디언 닫음, 클래스 제거됨');
                } else {
                    // 먼저 다른 모든 확장된 행들을 닫기 및 강조 해제
                    $('#projectsTable tbody tr').removeClass('accordion-open');
                    dataTable.rows().every(function() {
                        if (this.child.isShown()) {
                            this.child.hide();
                            $(this.node()).removeClass('shown accordion-open');
                        }
                    });
                    
                    // 현재 행 확장 및 강조
                    row.child(formatRowDetails(row.data())).show();
                    tr.addClass('shown accordion-open');
                    console.log('아코디언 열림, 클래스 추가됨:', tr.hasClass('accordion-open'));
                }
            });
        }

        // 행 상세 정보 포맷팅
        function formatRowDetails(rowData) {
            const projectCode = rowData['프로젝트 코드'] || '';
            
            return `
                <div class="row-details">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-4">

                            <!-- 모든 정보를 한 행에 가로로 배치 -->
                            <div class="all-info-container">
                                <div class="row">
                                    <!-- 기본정보 -->
                                    <div class="col-lg-3">
                                        <div class="info-card compact-card" id="card-basic-${projectCode}">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="text-primary mb-0">
                                                    <i class="fas fa-building me-1"></i>기본정보
                                                </h6>
                                                <div class="card-edit-buttons">
                                                    <button class="btn btn-sm edit-btn" onclick="toggleCardEdit('${projectCode}', 'basic')" 
                                                            style="padding: 0.2rem 0.4rem; font-size: 0.7rem; background-color: #ffeaa7; border: 1px solid #fdcb6e; color: #6c5ce7;"
                                                            title="수정">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm save-btn d-none" onclick="saveCardEdit('${projectCode}', 'basic')" 
                                                            style="padding: 0.2rem 0.4rem; font-size: 0.7rem; background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724;"
                                                            title="저장">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button class="btn btn-sm cancel-btn d-none" onclick="cancelCardEdit('${projectCode}', 'basic')" 
                                                            style="padding: 0.2rem 0.4rem; font-size: 0.7rem; background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; margin-left: 2px;"
                                                            title="취소">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="card-grid">
                                                <div class="compact-item">
                                                    <small>사업자</small>
                                                    <div class="editable-value" data-field="사업자">${rowData['사업자'] || '-'}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>현장담당자</small>
                                                    <div class="editable-value" data-field="현장 담당자">${rowData['현장 담당자'] || '-'}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>도급구분</small>
                                                    <div class="editable-value" data-field="도급 구분">${rowData['도급 구분'] || '-'}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>연락처</small>
                                                    <div class="editable-value" data-field="담당자 연락처">${rowData['담당자 연락처'] || '-'}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>시공자</small>
                                                    <div class="editable-value" data-field="시공자">${rowData['시공자'] || '-'}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>이메일</small>
                                                    <div class="editable-value" data-field="담당자 이메일">${rowData['담당자 이메일'] || '-'}</div>
                                                </div>
                                            </div>
                                            <div class="compact-item mt-2" style="grid-column: 1/-1; border-top: 1px solid var(--gray-200); padding-top: 0.5rem;">
                                                <small>현장 주소</small>
                                                <div class="editable-value" data-field="현장 주소" style="font-size: 0.85rem;">${rowData['현장 주소'] || '-'}</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 공사정보 -->
                                    <div class="col-lg-3">
                                        <div class="info-card compact-card" id="card-construction-${projectCode}">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="text-success mb-0">
                                                    <i class="fas fa-hammer me-1"></i>공사정보
                                                </h6>
                                                <button class="btn btn-sm" onclick="editProject('${projectCode}')" 
                                                        style="padding: 0.2rem 0.4rem; font-size: 0.7rem; background-color: #ffeaa7; border: 1px solid #fdcb6e; color: #6c5ce7;"
                                                        title="전체 수정">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                            <div class="card-grid">
                                                <div class="compact-item">
                                                    <small>공사구분</small>
                                                    <div>${rowData['공사 구분'] || '-'}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>공사확정</small>
                                                    <div>${rowData['공사 확정'] ? formatDate(rowData['공사 확정']) : '-'}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>기계분류</small>
                                                    <div>${rowData['기계 분류'] || '-'}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>공사시작</small>
                                                    <div>${rowData['공사 시작'] ? formatDate(rowData['공사 시작']) : '-'}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>브랜드</small>
                                                    <div>${rowData['브랜드'] || '-'}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>공사종료</small>
                                                    <div>${rowData['공사 종료'] ? formatDate(rowData['공사 종료']) : '-'}</div>
                                                </div>
                                            </div>
                                            <div class="compact-item mt-2" style="grid-column: 1/-1;">
                                                <small>공사내용</small>
                                                <div>${rowData['공사 내용'] || '-'}</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 금액정보 -->
                                    <div class="col-lg-3">
                                        <div class="info-card compact-card" id="card-financial-${projectCode}">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="text-warning mb-0">
                                                    <i class="fas fa-won-sign me-1"></i>금액정보
                                                </h6>
                                                <button class="btn btn-sm" onclick="editProject('${projectCode}')" 
                                                        style="padding: 0.2rem 0.4rem; font-size: 0.7rem; background-color: #ffeaa7; border: 1px solid #fdcb6e; color: #6c5ce7;"
                                                        title="전체 수정">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                            <div class="card-grid">
                                                <div class="compact-item">
                                                    <small>총액1</small>
                                                    <div class="text-success">${rowData['총액 1'] ? formatCurrency(rowData['총액 1']) : '-'}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>계산서</small>
                                                    <div>${rowData['계산서'] || rowData['X'] || '-'}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>부가세</small>
                                                    <div>${rowData['부가세'] === true || rowData['부가세'] === 'TRUE' ? '포함' : '별도'}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>마진율</small>
                                                    <div class="text-info">${rowData['마진율'] ? parseFloat(rowData['마진율']).toFixed(1) + '%' : '-'}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>총액2</small>
                                                    <div class="text-primary">${(() => {
                                                        const totalAmount = rowData['총액 2'] || rowData['총액2'] || rowData['S'] || rowData['총액'] || 0;
                                                        const numValue = parseFloat(totalAmount) || 0;
                                                        return numValue > 0 ? formatCurrency(numValue) : '-';
                                                    })()}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>순익</small>
                                                    <div class="text-success">${rowData['순익'] ? formatCurrency(rowData['순익']) : '-'}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 수금정보 -->
                                    <div class="col-lg-3">
                                        <div class="info-card compact-card" id="card-payment-${projectCode}">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="text-danger mb-0">
                                                    <i class="fas fa-credit-card me-1"></i>수금정보
                                                </h6>
                                                <button class="btn btn-sm" onclick="editProject('${projectCode}')" 
                                                        style="padding: 0.2rem 0.4rem; font-size: 0.7rem; background-color: #ffeaa7; border: 1px solid #fdcb6e; color: #6c5ce7;"
                                                        title="전체 수정">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                            <div class="card-grid">
                                                <div class="compact-item">
                                                    <small>계약금</small>
                                                    <div>${rowData['계약금'] ? formatCurrency(rowData['계약금']) : '-'}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>미수금</small>
                                                    <div class="${(() => {
                                                        const outstandingData = rowData['미수금W'] || rowData['미수금 W'] || rowData['W'] || rowData['미수금'] || 0;
                                                        const outstandingAmount = parseFloat(outstandingData) || 0;
                                                        return outstandingAmount === 0 ? 'text-success' : 'text-danger';
                                                    })()}">${(() => {
                                                        const outstandingData = rowData['미수금W'] || rowData['미수금 W'] || rowData['W'] || rowData['미수금'] || 0;
                                                        const outstandingAmount = parseFloat(outstandingData) || 0;
                                                        return outstandingAmount === 0 ? '완료' : formatCurrency(outstandingAmount);
                                                    })()}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>중도금</small>
                                                    <div>${rowData['중도금'] ? formatCurrency(rowData['중도금']) : '-'}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>수금확인</small>
                                                    <div>${(rowData['수금 확인'] === true || rowData['수금 확인'] === 'TRUE' || rowData['수금 확인'] === '✓' || rowData['수금 확인'] === 'true') ? 
                                                        '<span class="badge bg-success">완료</span>' : 
                                                        '<span class="badge bg-warning">대기</span>'}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>잔금</small>
                                                    <div>${rowData['잔금'] ? formatCurrency(rowData['잔금']) : '-'}</div>
                                                </div>
                                                <div class="compact-item">
                                                    <small>수금날짜</small>
                                                    <div>${rowData['수금 날짜'] ? formatDate(rowData['수금 날짜']) : '-'}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <!-- 문서 폴더 경로 -->
                            ${(() => {
                                const folderPath = rowData['견적서 및 계약서 폴더 경로'] || rowData['AK'] || '';
                                if (folderPath && folderPath.trim() !== '' && folderPath !== '-') {
                                    return `
                                    <div class="mt-3 p-3" style="background-color: #f8f9fa; border-radius: var(--border-radius); border: 1px solid var(--gray-200);">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-folder-open me-2" style="color: #ffc107; font-size: 1.1rem;"></i>
                                            <small class="text-muted me-2" style="font-weight: 600;">문서 폴더:</small>
                                            <div class="text-truncate" style="flex: 1;">
                                                <a href="#" onclick="openFolder('${folderPath.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}')" 
                                                   class="text-decoration-none" 
                                                   style="color: #17a2b8; font-size: 0.85rem;"
                                                   title="${folderPath}">
                                                    ${folderPath}
                                                </a>
                                            </div>
                                            <button class="btn btn-sm btn-outline-secondary ms-2" 
                                                    onclick="copyToClipboard('${folderPath.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}')"
                                                    title="경로 복사"
                                                    style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                    `;
                                }
                                return '';
                            })()}

                        </div>
                    </div>
                </div>
            `;
        }

        // 필터 강조 표시 업데이트
        function updateFilterHighlight(element) {
            if (element.value && element.value.trim() !== '') {
                element.classList.add('filter-selected');
            } else {
                element.classList.remove('filter-selected');
            }
        }

        // 이벤트 리스너 설정
        function setupEventListeners() {
            // 필터 변경 이벤트
            ['companyFilter', 'statusFilter', 'managerFilter', 'outstandingFilter'].forEach(filterId => {
                const element = document.getElementById(filterId);
                if (element) {
                    element.addEventListener('change', function() {
                        updateFilterHighlight(this);
                        applyFilters();
                    });
                } else {
                    console.warn(`Element with id '${filterId}' not found`);
                }
            });

            // 검색 입력 이벤트
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keyup', function(e) {
                    updateFilterHighlight(this);
                    if (e.key === 'Enter') {
                        applyFilters();
                    }
                });
            }

            
            // iframe에서 편집 완료 메시지 수신
            window.addEventListener('message', function(event) {
                if (event.data.type === 'projectUpdated') {
                    // 편집 모달 닫기
                    const editModal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                    if (editModal) {
                        editModal.hide();
                    }
                    
                    // 성공 메시지 표시
                    showAlert('프로젝트가 성공적으로 수정되었습니다!', 'success');
                    
                    // 데이터 다시 로드
                    setTimeout(loadProjects, 500);
                }
            });
        }

        // 상태 뱃지 생성 (Z열 수금 확인 기준)
        function getStatusBadge(row) {
            const startDateStr = row['공사 시작'] || '';
            const endDateStr = row['공사 종료'] || '';
            
            // Z열 수금 확인 데이터 확인
            const paymentConfirmed = row['수금 확인'] || row['Z'] || '';
            const isPaymentConfirmed = (paymentConfirmed === true || paymentConfirmed === 'TRUE' || 
                                      paymentConfirmed === '✓' || paymentConfirmed === 'true' || 
                                      paymentConfirmed === 'Y' || paymentConfirmed === 'y' ||
                                      paymentConfirmed === '1' || paymentConfirmed === 1);
            
            // 날짜 처리
            const startDate = startDateStr ? new Date(startDateStr) : null;
            const endDate = endDateStr ? new Date(endDateStr) : null;
            const today = new Date();
            today.setHours(0, 0, 0, 0); // 시간 부분 제거
            
            // 공사 종료 날짜가 있는 경우
            if (endDate) {
                const endDateOnly = new Date(endDate);
                endDateOnly.setHours(0, 0, 0, 0);
                
                if (endDateOnly < today) {
                    // 공사 종료 날짜가 지난 경우
                    if (isPaymentConfirmed) {
                        return '<span class="badge status-completed">공사완료</span>';
                    } else {
                        return '<span class="badge status-payment-pending">수금대기</span>';
                    }
                } else {
                    // 공사 종료 날짜가 아직 안 지난 경우
                    if (isPaymentConfirmed) {
                        return '<span class="badge status-prepaid">선입금</span>';
                    } else {
                        return '<span class="badge status-in-progress">공사진행중</span>';
                    }
                }
            } else {
                // 공사 종료 날짜가 없는 경우
                if (startDate) {
                    const startDateOnly = new Date(startDate);
                    startDateOnly.setHours(0, 0, 0, 0);
                    
                    // 공사 시작일이 지났고 수금 확인되면 공사완료
                    if (startDateOnly < today && isPaymentConfirmed) {
                        return '<span class="badge status-completed">공사완료</span>';
                    } else {
                        return '<span class="badge status-in-progress">공사진행중</span>';
                    }
                } else {
                    // 시작일도 없는 경우 진행중으로 처리
                    return '<span class="badge status-in-progress">공사진행중</span>';
                }
            }
        }

        // 필터 적용
        function applyFilters() {
            if (!dataTable) return;

            let filteredData = [...projectsData];

            // 사업자 필터
            const companyFilter = document.getElementById('companyFilter')?.value || '';
            if (companyFilter) {
                filteredData = filteredData.filter(row => row['사업자'] === companyFilter);
            }

            // 상태 필터 (새로운 로직)
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            if (statusFilter) {
                filteredData = filteredData.filter(row => {
                    const startDateStr = row['공사 시작'] || '';
                    const endDateStr = row['공사 종료'] || '';
                    const paymentConfirmed = row['수금 확인'] || row['Z'] || '';
                    const isPaymentConfirmed = (paymentConfirmed === true || paymentConfirmed === 'TRUE' || 
                                              paymentConfirmed === '✓' || paymentConfirmed === 'true' || 
                                              paymentConfirmed === 'Y' || paymentConfirmed === 'y' ||
                                              paymentConfirmed === '1' || paymentConfirmed === 1);
                    
                    const startDate = startDateStr ? new Date(startDateStr) : null;
                    const endDate = endDateStr ? new Date(endDateStr) : null;
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    switch (statusFilter) {
                        case 'completed':
                            // 공사완료: (종료일 지남 + 수금확인) 또는 (종료일 없고 시작일 지남 + 수금확인)
                            if (endDate) {
                                const endDateOnly = new Date(endDate);
                                endDateOnly.setHours(0, 0, 0, 0);
                                return endDateOnly < today && isPaymentConfirmed;
                            } else if (startDate) {
                                const startDateOnly = new Date(startDate);
                                startDateOnly.setHours(0, 0, 0, 0);
                                return startDateOnly < today && isPaymentConfirmed;
                            }
                            return false;
                            
                        case 'in-progress':
                            // 공사진행중: 수금미확인이고 (종료일 안지남 또는 종료일 없음)
                            if (endDate) {
                                const endDateOnly = new Date(endDate);
                                endDateOnly.setHours(0, 0, 0, 0);
                                return endDateOnly >= today && !isPaymentConfirmed;
                            } else if (startDate) {
                                // 종료일 없고 시작일 있는 경우
                                const startDateOnly = new Date(startDate);
                                startDateOnly.setHours(0, 0, 0, 0);
                                // 시작일 지났고 수금확인되면 완료, 아니면 진행중
                                return !(startDateOnly < today && isPaymentConfirmed);
                            }
                            return !isPaymentConfirmed; // 날짜 없으면 수금 여부로만 판단
                            
                        case 'payment-pending':
                            // 수금대기: 종료일 지남 + 수금미확인 (종료일 없으면 해당없음)
                            if (endDate) {
                                const endDateOnly = new Date(endDate);
                                endDateOnly.setHours(0, 0, 0, 0);
                                return endDateOnly < today && !isPaymentConfirmed;
                            }
                            return false; // 종료일 없으면 수금대기 아님
                            
                        case 'prepaid':
                            // 선입금: 종료일 안지남 + 수금확인
                            if (endDate) {
                                const endDateOnly = new Date(endDate);
                                endDateOnly.setHours(0, 0, 0, 0);
                                return endDateOnly >= today && isPaymentConfirmed;
                            }
                            return false; // 종료일 없으면 선입금 아님
                            
                        default:
                            return true;
                    }
                });
            }

            // 담당자 필터
            const managerFilter = document.getElementById('managerFilter')?.value || '';
            if (managerFilter) {
                filteredData = filteredData.filter(row => {
                    const manager = row['담당자'] || '';
                    return manager.toString().trim() === managerFilter;
                });
            }

            // 수금 상태 필터 (W열 미수금 기준)
            const outstandingFilter = document.getElementById('outstandingFilter')?.value || '';
            if (outstandingFilter) {
                filteredData = filteredData.filter(row => {
                    const outstandingData = row['미수금W'] || row['미수금 W'] || row['W'] || row['미수금'] || 0;
                    const outstandingAmount = parseFloat(outstandingData) || 0;
                    
                    if (outstandingFilter === 'collected') {
                        // 수금 완료: 미수금이 0인 경우
                        return outstandingAmount === 0;
                    } else if (outstandingFilter === 'outstanding') {
                        // 미수금 있음: 미수금이 0보다 큰 경우
                        return outstandingAmount > 0;
                    }
                    return true;
                });
            }

            // 검색어 필터
            const searchInput = document.getElementById('searchInput')?.value?.toLowerCase() || '';
            if (searchInput) {
                filteredData = filteredData.filter(row => {
                    const searchFields = [
                        row['프로젝트 코드'],
                        row['현장 주소'],
                        row['거래처'],
                        row['담당자'],
                        row['브랜드'],
                        row['공사 내용']
                    ];
                    
                    return searchFields.some(field => 
                        field && field.toString().toLowerCase().includes(searchInput)
                    );
                });
            }

            // DataTable 업데이트
            dataTable.clear().rows.add(filteredData).draw();
        }

        // 필터 초기화
        function clearFilters() {
            ['companyFilter', 'statusFilter', 'managerFilter', 'outstandingFilter'].forEach(filterId => {
                const element = document.getElementById(filterId);
                if (element) {
                    element.value = '';
                    element.classList.remove('filter-selected');
                }
            });
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
                searchInput.classList.remove('filter-selected');
            }
            
            if (dataTable) {
                dataTable.clear().rows.add(projectsData).draw();
            }
        }

        // 프로젝트 상세보기
        function viewProject(projectCode) {
            const project = projectsData.find(p => p['프로젝트 코드'] === projectCode);
            if (!project) return;

            // 프로젝트 정보를 모달에 표시 (모든 데이터)
            const viewInfo = document.getElementById('viewProjectInfo');
            
            // 아코디언 상위 메뉴 데이터와 통합한 포괄적인 카테고리 분류
            const categories = {
                '기본정보': {
                    icon: 'fas fa-info-circle',
                    color: 'primary',
                    fields: ['프로젝트 코드', '거래처', '담당자', '현장 주소', '사업자', '담당자 연락처', '담당자 이메일', '현장 담당자', '도급 구분', '시공자']
                },
                '공사정보': {
                    icon: 'fas fa-hammer',
                    color: 'success',
                    fields: ['공사 내용', '공사 시작', '공사 종료', '공사 확정', '브랜드', '기계 분류', '공사 구분', '계약 형태']
                },
                '금액정보': {
                    icon: 'fas fa-won-sign',
                    color: 'warning',
                    fields: ['총액 1', '총액 2', '계약금', '중도금', '잔금', '제품대', '도급비', '자재비', '기타비', '순익', '마진율']
                },
                '수금정보': {
                    icon: 'fas fa-credit-card',
                    color: 'info',
                    fields: ['미수금', '미수금W', '부가세', '수금 날짜', '수금 확인', '계약금 입금자명', '중도금 입금자명', '잔금 입금자명', '계산서']
                },
                '파일 및 기타': {
                    icon: 'fas fa-folder',
                    color: 'secondary',
                    fields: ['견적서 및 계약서 폴더 경로', '비고', 'Airtable Record ID']
                }
            };
            
            // 상태 정보 계산
            const getStatusInfo = () => {
                const paymentConfirmed = project['수금 확인'] || project['Z'] || '';
                const isPaymentConfirmed = (paymentConfirmed === true || paymentConfirmed === 'TRUE' || 
                                          paymentConfirmed === '✓' || paymentConfirmed === 'true' || 
                                          paymentConfirmed === 'Y' || paymentConfirmed === 'y' ||
                                          paymentConfirmed === '1' || paymentConfirmed === 1);
                
                if (isPaymentConfirmed) {
                    return '<span class="badge bg-success fs-6 px-3 py-2"><i class="fas fa-check-circle me-1"></i>수금 완료</span>';
                } else {
                    return '<span class="badge bg-warning fs-6 px-3 py-2"><i class="fas fa-clock me-1"></i>수금 대기</span>';
                }
            };
            
            let html = `
                <div class="project-detail-view">
                    <!-- 헤더 정보 -->
                    <div class="detail-header mb-4 p-4 bg-light rounded-3">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h4 class="mb-2">
                                    <i class="fas fa-project-diagram me-2"></i>
                                    ${createProjectBadge(project['프로젝트 코드'])}
                                </h4>
                                <h5 class="text-muted mb-0">${createCompanyBadge(project['거래처'])}</h5>
                                <p class="mb-0 text-secondary">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    ${project['현장 주소'] || '-'}
                                </p>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="mb-3">${getStatusInfo()}</div>
                                <h4 class="text-success mb-1">
                                    ${(() => {
                                        const totalAmount = project['총액 2'] || project['총액2'] || project['S'] || project['총액'] || 0;
                                        const numValue = parseFloat(totalAmount) || 0;
                                        return numValue > 0 ? formatCurrency(numValue) : '-';
                                    })()}
                                </h4>
                                <small class="text-muted">총 계약금액</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 상세 정보 카드들 -->
                    <div class="row">`;
            
            Object.entries(categories).forEach(([categoryName, categoryInfo]) => {
                html += `
                    <div class="col-lg-6 mb-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-${categoryInfo.color} bg-opacity-10 border-0">
                                <h6 class="mb-0 text-${categoryInfo.color}">
                                    <i class="${categoryInfo.icon} me-2"></i>
                                    ${categoryName}
                                </h6>
                            </div>
                            <div class="card-body">`;
                
                categoryInfo.fields.forEach(field => {
                    let value = project[field];
                    let displayValue = '-';
                    let valueClass = 'text-muted';
                    
                    if (value !== undefined && value !== null && value !== '') {
                        // 날짜 필드 처리
                        if (field.includes('날짜') || field.includes('시작') || field.includes('종료') || field.includes('확정')) {
                            displayValue = formatDate(value) || '-';
                            valueClass = 'text-dark';
                        }
                        // 금액 필드 처리
                        else if (field.includes('총액') || field.includes('금') || field.includes('비') || field.includes('익') || field === '제품대' || field === '도급비' || field === '자재비' || field === '기타비' || field === '순익' || field === '미수금W' || field === '미수금') {
                            const numValue = parseFloat(value) || 0;
                            if (numValue > 0) {
                                displayValue = formatCurrency(numValue);
                                valueClass = field.includes('미수금') ? 'text-danger fw-bold' : 'text-success fw-bold';
                            }
                        }
                        // 마진율 처리
                        else if (field === '마진율') {
                            const numValue = parseFloat(value) || 0;
                            if (numValue !== 0) {
                                displayValue = numValue.toFixed(2) + '%';
                                valueClass = numValue > 0 ? 'text-success fw-bold' : 'text-danger fw-bold';
                            }
                        }
                        // 불린 필드 처리
                        else if (field === '부가세' || field === '수금 확인') {
                            const isTrue = value === true || value === 'TRUE' || value === '✓' || value === 'true';
                            displayValue = isTrue ? '<i class="fas fa-check text-success"></i> 확인' : '<i class="fas fa-times text-danger"></i> 미확인';
                            valueClass = '';
                        }
                        // 뱃지 적용 필드들
                        else if (field === '프로젝트 코드') {
                            displayValue = createProjectBadge(value);
                            valueClass = '';
                        }
                        else if (field === '담당자') {
                            displayValue = createManagerBadge(value);
                            valueClass = '';
                        }
                        else if (field === '거래처' || field === '사업자') {
                            displayValue = createCompanyBadge(value);
                            valueClass = '';
                        }
                        // 일반 텍스트
                        else {
                            displayValue = String(value);
                            valueClass = 'text-dark';
                        }
                    }
                    
                    html += `
                        <div class="row mb-2 align-items-center">
                            <div class="col-5">
                                <small class="fw-semibold text-secondary">${field}</small>
                            </div>
                            <div class="col-7">
                                <span class="${valueClass}">${displayValue}</span>
                            </div>
                        </div>`;
                });
                
                html += `
                            </div>
                        </div>
                    </div>`;
            });
            
            html += `
                    </div>
                </div>`;
            
            viewInfo.innerHTML = html;
            
            // 현재 보고 있는 프로젝트 코드 저장
            window.currentViewProject = projectCode;
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('viewModal'));
            modal.show();
        }

        // 프로젝트 수정
        function editProject(projectCode) {
            // iframe에 편집 페이지 로드
            document.getElementById('editFrame').src = `/project/edit?code=${projectCode}`;
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
            
            // 편집 완료 후 테이블 새로고침을 위해 프로젝트 코드 저장
            window.currentEditProject = projectCode;
        }

        // 보기 모달에서 편집 모달로 전환
        function openEditFromView() {
            if (!window.currentViewProject) return;
            
            // 보기 모달 닫기
            const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewModal'));
            viewModal.hide();
            
            // 편집 모달 열기
            setTimeout(() => {
                editProject(window.currentViewProject);
            }, 300); // 모달 닫힘 애니메이션 대기
        }

        // 새 프로젝트 모달 열기
        async function openNewProjectModal() {
            try {
                // 기존 데이터 로드
                await loadModalData();
                
                // 모달 표시
                const modal = new bootstrap.Modal(document.getElementById('newProjectModal'));
                modal.show();
                
                // 폼 초기화
                resetNewProjectForm();
                
            } catch (error) {
                console.error('모달 데이터 로드 오류:', error);
                showAlert('데이터를 로드하는 중 오류가 발생했습니다.', 'danger');
            }
        }

        // 모달용 데이터 로드
        async function loadModalData() {
            try {
                // 옵션 데이터 로드
                const optionsResponse = await fetch('/api/meta/options');
                const optionsData = await optionsResponse.json();
                
                // 담당자 목록 (제외할 인원 필터링)
                const excludedOwners = ['김단이', '심장원', '아이티', '이근혁', '황샛별'];
                const filteredOwners = optionsData.owners.filter(owner => !excludedOwners.includes(owner));
                
                // 담당자 드롭다운 채우기
                const ownerSelect = document.getElementById('owner');
                ownerSelect.innerHTML = '<option value="">담당자 선택</option>';
                filteredOwners.forEach(owner => {
                    const option = document.createElement('option');
                    option.value = owner;
                    option.textContent = owner;
                    ownerSelect.appendChild(option);
                });

                // 거래처 자동완성 데이터 로드
                const clientsResponse = await fetch('/api/projects/list');
                const projectsData = await clientsResponse.json();
                
                // 고유한 거래처 목록 추출
                const uniqueClients = [...new Set(projectsData
                    .map(p => p['거래처'])
                    .filter(client => client && client.trim())
                )].sort();
                
                // 디버깅: 피이스 관련 거래처 찾기
                const psCompanies = uniqueClients.filter(client => 
                    client.includes('피이스') || client.includes('마케팅') || client.includes('P&S') || client.includes('피')
                );
                console.log('피이스 관련 거래처들:', psCompanies);
                
                
                // 거래처 datalist 채우기
                const clientDatalist = document.getElementById('clientList');
                clientDatalist.innerHTML = '';
                uniqueClients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client;
                    clientDatalist.appendChild(option);
                });

                // 공사 구분 드롭다운 채우기
                if (optionsData.work_categories && optionsData.work_categories.length > 0) {
                    const workCategorySelect = document.getElementById('work-category');
                    workCategorySelect.innerHTML = '<option value="">선택</option>';
                    optionsData.work_categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        workCategorySelect.appendChild(option);
                    });
                }

                // 기계 분류와 브랜드는 이제 체크박스로 고정 구현됨 (동적 로딩 불필요)

            } catch (error) {
                console.error('데이터 로드 오류:', error);
                throw error;
            }
        }

        // 새 프로젝트 폼 초기화
        function resetNewProjectForm() {
            document.getElementById('newProjectForm').reset();
            document.getElementById('generated-code').textContent = '사업자와 담당자를 선택하세요';
            document.getElementById('generated-code').style.backgroundColor = '#f8f9fa';
            document.getElementById('display-amount').textContent = '0원';
            document.getElementById('amount-korean').textContent = '금 영원정';
            
            // 이벤트 리스너 설정
            setupNewProjectFormListeners();
        }

        // 새 프로젝트 폼 이벤트 리스너 설정
        function setupNewProjectFormListeners() {
            // 사업자/담당자 변경 시 프로젝트 코드 미리보기
            document.getElementById('company').addEventListener('change', updateNewProjectCodePreview);
            document.getElementById('owner').addEventListener('change', updateNewProjectCodePreview);
            
            // 공사 구분 다중 선택 처리
            document.querySelectorAll('.work-category-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleWorkCategoryChange);
            });
            
            // 기계 분류 다중 선택 처리
            document.querySelectorAll('.machine-category-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleMachineCategoryChange);
            });
            
            // 브랜드 다중 선택 처리
            document.querySelectorAll('.brand-category-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleBrandCategoryChange);
            });
            
            // 도급 구분 다중 선택 처리
            document.querySelectorAll('.contract-category-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleContractCategoryChange);
            });
            
            // 현장 주소 자동 정리 및 검증
            document.getElementById('address').addEventListener('input', handleAddressInput);
            document.getElementById('address').addEventListener('paste', handleAddressPaste);
            
            // 총액1 쉼표 표시 및 금액 업데이트
            document.getElementById('total-amount-display').addEventListener('input', handleAmountInput);
            document.getElementById('vat-included').addEventListener('change', updateDisplayAmount);
            
            // 금액 버튼 이벤트 리스너
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const amount = parseInt(this.dataset.amount);
                    addAmountToTotal(amount);
                });
            });
            
            // 초기화 버튼 이벤트 리스너
            document.getElementById('amount-reset-btn').addEventListener('click', function() {
                resetTotalAmount();
            });
            
            // 캘린더 관련 이벤트 처리 함수
            function openCalendar(dateInput) {
                if (dateInput && !dateInput.disabled) {
                    dateInput.focus();
                    // 브라우저별 호환성을 위한 다중 시도
                    try {
                        if (dateInput.showPicker) {
                            dateInput.showPicker();
                        }
                    } catch (e) {
                        // showPicker가 지원되지 않는 경우 focus로 대체
                        dateInput.focus();
                    }
                }
            }
            
            // 캘린더 아이콘 클릭 이벤트
            document.querySelectorAll('.calendar-icon').forEach(icon => {
                icon.addEventListener('click', function() {
                    const dateInput = this.parentElement.querySelector('input[type="date"]');
                    openCalendar(dateInput);
                });
            });
            
            // 날짜 입력 필드 자체 클릭 이벤트
            document.querySelectorAll('.date-input').forEach(input => {
                input.addEventListener('click', function() {
                    openCalendar(this);
                });
            });
            
            // 동일 날짜 체크박스 이벤트
            document.getElementById('same-date-check').addEventListener('change', function() {
                const startDate = document.getElementById('start-date').value;
                const endDateInput = document.getElementById('end-date');
                
                if (this.checked) {
                    if (startDate) {
                        endDateInput.value = startDate;
                        endDateInput.disabled = true;
                    } else {
                        // 시작일이 없으면 체크박스 해제
                        this.checked = false;
                        alert('먼저 공사 시작일을 선택해주세요.');
                    }
                } else {
                    endDateInput.disabled = false;
                }
            });
            
            // 이메일 확인 불가 체크박스 이벤트
            document.getElementById('email-unknown-check').addEventListener('change', function() {
                const emailInput = document.getElementById('manager-email');
                const emailError = document.getElementById('email-error');
                
                if (this.checked) {
                    emailInput.value = '-';
                    emailInput.disabled = true;
                    emailInput.classList.remove('is-invalid');
                    emailError.classList.add('d-none');
                } else {
                    emailInput.value = '';
                    emailInput.disabled = false;
                }
            });
            
            // 이메일 형식 검증
            document.getElementById('manager-email').addEventListener('input', function() {
                const emailInput = this;
                const emailError = document.getElementById('email-error');
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                // 체크박스가 체크되어 있으면 검증 건너뛰기
                if (document.getElementById('email-unknown-check').checked) {
                    return;
                }
                
                // 빈 값이면 에러 숨김
                if (emailInput.value.trim() === '') {
                    emailInput.classList.remove('is-invalid');
                    emailError.classList.add('d-none');
                    return;
                }
                
                // 이메일 형식 검증
                if (!emailRegex.test(emailInput.value)) {
                    emailInput.classList.add('is-invalid');
                    emailError.classList.remove('d-none');
                } else {
                    emailInput.classList.remove('is-invalid');
                    emailError.classList.add('d-none');
                }
            });
            
            // 이메일 필드 포커스 아웃 시에도 검증
            document.getElementById('manager-email').addEventListener('blur', function() {
                const emailInput = this;
                const emailError = document.getElementById('email-error');
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                // 체크박스가 체크되어 있으면 검증 건너뛰기
                if (document.getElementById('email-unknown-check').checked) {
                    return;
                }
                
                // 빈 값이 아닌데 형식이 잘못된 경우
                if (emailInput.value.trim() !== '' && !emailRegex.test(emailInput.value)) {
                    emailInput.classList.add('is-invalid');
                    emailError.classList.remove('d-none');
                }
            });
            
            // 폼 제출
            document.getElementById('newProjectForm').addEventListener('submit', submitNewProject);
        }

        // 모달 전용 알림 함수
        function showModalAlert(message, type) {
            const alertContainer = document.getElementById('modalAlertContainer');
            const alertId = 'modal_alert_' + Date.now();
            
            const alertHTML = `
                <div class="alert alert-${type} alert-dismissible fade show mb-3" id="${alertId}">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.innerHTML = alertHTML;
            
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.remove();
                }
            }, 3000);
        }

        // 시작일 변경 시 처리
        function handleStartDateChange() {
            const sameDateCheck = document.getElementById('same-date-check');
            const startDate = document.getElementById('start-date').value;
            const endDateInput = document.getElementById('end-date');
            
            // 체크박스가 체크되어 있으면 종료일도 동일하게 설정
            if (sameDateCheck.checked && startDate) {
                endDateInput.value = startDate;
            }
        }

        // 새 프로젝트 코드 미리보기 업데이트
        async function updateNewProjectCodePreview() {
            const company = document.getElementById('company').value;
            const owner = document.getElementById('owner').value;
            const codeDisplay = document.getElementById('generated-code');
            
            if (company && owner) {
                try {
                    // 실제 프로젝트 코드 미리보기 API 호출
                    const response = await fetch(`/api/preview-project-code?company=${encodeURIComponent(company)}&owner=${encodeURIComponent(owner)}`);
                    const result = await response.json();
                    
                    if (result.ok) {
                        codeDisplay.textContent = result.project_code;
                        codeDisplay.style.backgroundColor = '#e8f5e8';
                    } else {
                        codeDisplay.textContent = `오류: ${result.error}`;
                        codeDisplay.style.backgroundColor = '#f8d7da';
                    }
                } catch (error) {
                    console.error('프로젝트 코드 미리보기 오류:', error);
                    codeDisplay.textContent = '코드 생성 오류';
                    codeDisplay.style.backgroundColor = '#f8d7da';
                }
            } else {
                codeDisplay.textContent = '사업자와 담당자를 선택하세요';
                codeDisplay.style.backgroundColor = '#f8f9fa';
            }
        }

        // 표시 금액 업데이트
        function updateDisplayAmount() {
            const amount = parseFloat(document.getElementById('total-amount').value) || 0;
            const vatIncluded = document.getElementById('vat-included').checked;
            
            let displayAmount = amount;
            if (vatIncluded) {
                displayAmount = amount * 1.1; // 부가세 10% 추가
            }
            
            // 총액2 표시 업데이트 (기존 display-amount span 사용)
            const displayAmountSpan = document.getElementById('display-amount');
            const amountKoreanSpan = document.getElementById('amount-korean');
            
            if (displayAmountSpan && displayAmount > 0) {
                const formattedAmount = new Intl.NumberFormat('ko-KR').format(displayAmount);
                const koreanAmount = numberToKorean(displayAmount);
                
                // VAT 정보 추가
                const vatStatus = vatIncluded ? 'VAT 포함' : 'VAT 별도';
                
                // 한글 금액과 VAT 정보를 함께 표시
                displayAmountSpan.textContent = `${formattedAmount}원 (금 ${koreanAmount}원정) / ${vatStatus}`;
                
                // 기존 한글 표시 숨김
                if (amountKoreanSpan) {
                    amountKoreanSpan.style.display = 'none';
                }
                
                // 실제 값은 숨겨진 총액2 필드에 저장 (폼 제출용)
                let hiddenTotal2 = document.getElementById('total2-hidden');
                if (!hiddenTotal2) {
                    hiddenTotal2 = document.createElement('input');
                    hiddenTotal2.type = 'hidden';
                    hiddenTotal2.id = 'total2-hidden';
                    hiddenTotal2.name = '총액 2';
                    document.getElementById('newProjectForm').appendChild(hiddenTotal2);
                }
                hiddenTotal2.value = displayAmount;
                
            } else if (displayAmountSpan) {
                displayAmountSpan.textContent = '0원';
                if (amountKoreanSpan) {
                    amountKoreanSpan.textContent = '(금 영원정)';
                    amountKoreanSpan.style.display = 'inline';
                }
            }
        }

        // 공사 구분 다중 선택 처리 (최대 2개)
        function handleWorkCategoryChange(event) {
            const checkbox = event.target;
            const checkboxes = document.querySelectorAll('.work-category-checkbox');
            const checkedBoxes = document.querySelectorAll('.work-category-checkbox:checked');
            
            if (checkedBoxes.length > 2) {
                checkbox.checked = false;
                showModalAlert('공사 구분은 최대 2개까지만 선택 가능합니다.', 'warning');
                return;
            }
            
            // 선택된 값들을 숨겨진 필드에 저장
            const selectedValues = Array.from(checkedBoxes).map(cb => cb.value);
            const hiddenInput = document.getElementById('work-category-hidden') || 
                (() => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.id = 'work-category-hidden';
                    input.name = '공사 구분';
                    document.getElementById('newProjectForm').appendChild(input);
                    return input;
                })();
            
            hiddenInput.value = selectedValues.join(', ');
        }
        
        // 기계 분류 다중 선택 처리 (최대 2개)
        function handleMachineCategoryChange(event) {
            const checkbox = event.target;
            const checkedBoxes = document.querySelectorAll('.machine-category-checkbox:checked');
            
            if (checkedBoxes.length > 2) {
                checkbox.checked = false;
                showModalAlert('기계 분류는 최대 2개까지만 선택 가능합니다.', 'warning');
                return;
            }
            
            // 선택된 값들을 숨겨진 필드에 저장
            const selectedValues = Array.from(checkedBoxes).map(cb => cb.value);
            const hiddenInput = document.getElementById('machine-category-hidden') || 
                (() => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.id = 'machine-category-hidden';
                    input.name = '기계 분류';
                    document.getElementById('newProjectForm').appendChild(input);
                    return input;
                })();
            
            hiddenInput.value = selectedValues.join(', ');
        }
        
        // 브랜드 다중 선택 처리 (최대 2개)
        function handleBrandCategoryChange(event) {
            const checkbox = event.target;
            const checkedBoxes = document.querySelectorAll('.brand-category-checkbox:checked');
            
            if (checkedBoxes.length > 2) {
                checkbox.checked = false;
                showModalAlert('브랜드는 최대 2개까지만 선택 가능합니다.', 'warning');
                return;
            }
            
            // 선택된 값들을 숨겨진 필드에 저장
            const selectedValues = Array.from(checkedBoxes).map(cb => cb.value);
            const hiddenInput = document.getElementById('brand-category-hidden') || 
                (() => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.id = 'brand-category-hidden';
                    input.name = '브랜드';
                    document.getElementById('newProjectForm').appendChild(input);
                    return input;
                })();
            
            hiddenInput.value = selectedValues.join(', ');
        }
        
        // 도급 구분 다중 선택 처리 (최대 2개)
        function handleContractCategoryChange(event) {
            const checkbox = event.target;
            const checkedBoxes = document.querySelectorAll('.contract-category-checkbox:checked');
            
            if (checkedBoxes.length > 2) {
                checkbox.checked = false;
                showModalAlert('도급 구분은 최대 2개까지만 선택 가능합니다.', 'warning');
                return;
            }
            
            // 선택된 값들을 숨겨진 필드에 저장
            const selectedValues = Array.from(checkedBoxes).map(cb => cb.value);
            const hiddenInput = document.getElementById('contract-category-hidden') || 
                (() => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.id = 'contract-category-hidden';
                    input.name = '도급 구분';
                    document.getElementById('newProjectForm').appendChild(input);
                    return input;
                })();
            
            hiddenInput.value = selectedValues.join(', ');
        }
        
        // 현장 주소 입력 처리
        function handleAddressInput(event) {
            const address = event.target.value;
            const validationMsg = document.getElementById('address-validation');
            
            // 서울시 관련 문구 자동 정리
            let cleanedAddress = address
                .replace(/서울특별시\s?/g, '서울시 ')
                .replace(/서울시\s?서울시\s?/g, '서울시 ')
                .replace(/서울\s?서울/g, '서울');
            
            if (cleanedAddress !== address) {
                event.target.value = cleanedAddress;
            }
            
            // 도로명 주소 검증
            if (cleanedAddress.length > 5) {
                const hasRoadName = /로\d*번길|로\d*길|로\s\d+|대로\d*번길|대로\d*길|대로\s\d+/.test(cleanedAddress);
                
                if (hasRoadName) {
                    validationMsg.textContent = '✓ 유효한 도로명 주소입니다';
                    validationMsg.className = 'text-success small mt-1';
                } else {
                    validationMsg.textContent = '⚠ 도로명 주소로 입력해 주세요 (예: ○○로 123, ○○길 45)';
                    validationMsg.className = 'text-warning small mt-1';
                }
            } else {
                validationMsg.textContent = '';
            }
        }
        
        // 현장 주소 붙여넣기 처리
        function handleAddressPaste(event) {
            setTimeout(() => {
                handleAddressInput(event);
            }, 10);
        }
        
        // 총액 입력 처리 (3자리마다 쉼표 표시)
        function handleAmountInput(event) {
            const input = event.target;
            let value = input.value.replace(/[^\d]/g, ''); // 숫자만 추출
            
            if (value) {
                // 3자리마다 쉼표 추가
                const formattedValue = new Intl.NumberFormat('ko-KR').format(value);
                input.value = formattedValue;
                
                // 실제 숫자값을 숨겨진 필드에 저장
                document.getElementById('total-amount').value = value;
            } else {
                input.value = '';
                document.getElementById('total-amount').value = '';
            }
            
            // 총액2 업데이트
            updateDisplayAmount();
        }
        
        // 금액을 총액에 합산하는 함수
        function addAmountToTotal(amount) {
            const displayInput = document.getElementById('total-amount-display');
            const hiddenInput = document.getElementById('total-amount');
            
            // 현재 금액 가져오기
            let currentAmount = parseInt(hiddenInput.value) || 0;
            
            // 새 금액 합산
            const newAmount = currentAmount + amount;
            
            // 표시용 입력 필드에 포맷된 값 설정
            const formattedAmount = new Intl.NumberFormat('ko-KR').format(newAmount);
            displayInput.value = formattedAmount;
            
            // 숨겨진 필드에 실제 숫자값 저장
            hiddenInput.value = newAmount;
            
            // 총액2 업데이트
            updateDisplayAmount();
        }
        
        // 총액 초기화 함수
        function resetTotalAmount() {
            const displayInput = document.getElementById('total-amount-display');
            const hiddenInput = document.getElementById('total-amount');
            
            // 필드 초기화
            displayInput.value = '';
            hiddenInput.value = '0';
            
            // 총액2 업데이트
            updateDisplayAmount();
        }

        // 숫자를 한글로 변환하는 함수
        function numberToKorean(number) {
            // undefined, null, 빈 문자열, NaN 처리
            if (number === undefined || number === null || number === '' || isNaN(number)) {
                return "영";
            }
            
            // 숫자로 변환
            number = Math.floor(Number(number));
            
            if (number === 0) return "영";
            
            const units = ['', '만', '억', '조'];
            const nums = ['', '일', '이', '삼', '사', '오', '육', '칠', '팔', '구'];
            const tens = ['', '십', '백', '천'];
            
            let result = '';
            let unitIndex = 0;
            
            while (number > 0) {
                const part = number % 10000;
                if (part > 0) {
                    let partStr = '';
                    
                    // 천의 자리
                    if (Math.floor(part / 1000) > 0) {
                        const thousand = Math.floor(part / 1000);
                        if (thousand > 1) partStr += nums[thousand];
                        partStr += tens[3];
                    }
                    
                    // 백의 자리
                    if (Math.floor((part % 1000) / 100) > 0) {
                        const hundred = Math.floor((part % 1000) / 100);
                        if (hundred > 1) partStr += nums[hundred];
                        partStr += tens[2];
                    }
                    
                    // 십의 자리
                    if (Math.floor((part % 100) / 10) > 0) {
                        const ten = Math.floor((part % 100) / 10);
                        if (ten > 1) partStr += nums[ten];
                        partStr += tens[1];
                    }
                    
                    // 일의 자리
                    if (part % 10 > 0) {
                        partStr += nums[part % 10];
                    }
                    
                    result = partStr + units[unitIndex] + result;
                }
                
                number = Math.floor(number / 10000);
                unitIndex++;
            }
            
            return result;
        }

        // 새 프로젝트 제출 (재시도 로직 포함)
        async function submitNewProject(e, retryCount = 0) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-new-project');
            const loading = document.getElementById('submit-loading');
            const maxRetries = 3;
            
            // 로딩 상태
            submitBtn.disabled = true;
            loading.classList.remove('d-none');
            
            try {
                // 폼 데이터 수집
                const formData = new FormData(document.getElementById('newProjectForm'));
                const data = {};
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }
                
                // 부가세 체크박스 처리
                data['부가세 포함'] = document.getElementById('vat-included').checked;
                
                const response = await fetch('/api/projects/auto', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    showAlert(`프로젝트가 성공적으로 등록되었습니다! 프로젝트 코드: ${result.project_code}`, 'success');
                    
                    // 모달 닫기
                    const modal = bootstrap.Modal.getInstance(document.getElementById('newProjectModal'));
                    modal.hide();
                    
                    // 데이터 다시 로드
                    setTimeout(loadProjects, 500);
                    
                } else if (response.status === 409 && retryCount < maxRetries) {
                    // 409 충돌 오류 시 자동 재시도
                    console.warn(`프로젝트 코드 충돌, 재시도 중... (${retryCount + 1}/${maxRetries})`);
                    
                    // 프로젝트 코드 미리보기 업데이트
                    await updateNewProjectCodePreview();
                    
                    // 잠시 대기 후 재시도
                    await new Promise(resolve => setTimeout(resolve, 500 * (retryCount + 1)));
                    return await submitNewProject(e, retryCount + 1);
                    
                } else {
                    const errorMsg = result.error || '알 수 없는 오류가 발생했습니다.';
                    if (response.status === 409) {
                        showAlert(`${errorMsg} 다시 시도해주세요.`, 'warning');
                    } else {
                        showAlert(`등록 실패: ${errorMsg}`, 'danger');
                    }
                }
                
            } catch (error) {
                console.error('등록 오류:', error);
                if (retryCount < maxRetries) {
                    console.warn(`네트워크 오류, 재시도 중... (${retryCount + 1}/${maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1)));
                    return await submitNewProject(e, retryCount + 1);
                } else {
                    showAlert('서버 통신 중 오류가 발생했습니다. 다시 시도해주세요.', 'danger');
                }
            } finally {
                // 로딩 상태 해제
                submitBtn.disabled = false;
                loading.classList.add('d-none');
            }
        }


        // 데이터 내보내기
        function exportData() {
            // 현재 필터된 데이터를 CSV로 내보내기
            const data = dataTable.rows({ search: 'applied' }).data().toArray();
            
            if (data.length === 0) {
                showAlert('내보낼 데이터가 없습니다.', 'warning');
                return;
            }

            const headers = [
                '프로젝트 코드', '사업자', '담당자', '거래처', '현장 주소', '공사 구분',
                '기계 분류', '브랜드', '공사 시작', '공사 종료', '공사 내용', '총액 2', '미수금'
            ];

            let csvContent = headers.join(',') + '\n';
            
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                csvContent += values.join(',') + '\n';
            });

            // 파일 다운로드
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `프로젝트목록_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 프로젝트 데이터 새로고침
        async function refreshProjectData() {
            const btn = document.getElementById('refreshProjectBtn');
            const icon = btn.querySelector('i');
            
            // 로딩 상태
            icon.className = 'fas fa-spinner fa-spin';
            btn.disabled = true;
            showLoading(true);
            
            try {
                const response = await fetch('/api/refresh-data');
                const result = await response.json();
                
                if (result.error) {
                    showAlert(result.error, 'danger');
                } else {
                    showAlert(`데이터를 성공적으로 새로고침했습니다. (${result.record_count}건)`, 'success');
                    
                    // 페이지 새로고침으로 데이터 반영
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            } catch (error) {
                console.error('새로고침 오류:', error);
                showAlert('데이터 새로고침에 실패했습니다.', 'danger');
            } finally {
                // 버튼 복원
                icon.className = 'fas fa-sync-alt';
                btn.disabled = false;
                showLoading(false);
            }
        }

        // 로딩 표시 - 완전히 비활성화
        function showLoading(show) {
            // 로딩 오버레이를 완전히 비활성화
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
                overlay.classList.remove('show');
            }
        }

        // 뱃지 생성 함수들
        function createProjectBadge(projectCode) {
            if (!projectCode) return '';
            const firstChar = projectCode.charAt(0).toUpperCase();
            let badgeClass = '';
            let badgeText = '';
            
            if (firstChar === 'R') {
                badgeClass = 'r-type';
                badgeText = 'R';
            } else if (firstChar === 'G') {
                badgeClass = 'g-type';
                badgeText = 'G';
            } else if (firstChar === 'P') {
                badgeClass = 'p-type';
                badgeText = 'P';
            } else if (firstChar === 'I') {
                badgeClass = 'i-type';
                badgeText = 'I';
            }
            
            if (badgeClass) {
                return `<span class="project-badge ${badgeClass}">${badgeText}</span><span class="ms-1">${projectCode}</span>`;
            }
            return projectCode;
        }

        function createManagerBadge(manager) {
            if (!manager) return '';
            
            // 경영지원팀 (관리만 하는 사람들)
            const managementTeam = ['고광일', '황샛별'];
            // 퇴사자들
            const resignedTeam = ['심장원', '아이티', '이근혁', '김단이'];
            
            // 전체 담당자 파스텔 색상 매핑 - 색상 다양화
            const colors = {
                // 영업팀 (현직) - 서로 다른 색상 계열로 구분
                '박정우': '#cce7ff',      // 연한 파란색
                '강성환': '#d4edda',      // 연한 초록색
                '박용구': '#d1ecf1',      // 연한 청록색
                '박민우': '#fff0e6',      // 연한 살구색 (보라색에서 변경)
                '권태훈': '#fff3cd',      // 연한 노란색
                '주영민': '#e8f5e8',      // 연한 민트색 (하늘색에서 변경)
                '빈승정': '#e2d9f3',      // 연한 보라색 (라벤더에서 변경)
                '박민재': '#f0d9ff',      // 연한 라벤더색 (민트에서 변경)
                '조성헌': '#ffeaa7',      // 연한 복숭아색
                '황해승': '#ffe4e6',      // 연한 핑크색
                '강민석': '#ccf2ff'       // 연한 시안
            };
            
            const isManagement = managementTeam.includes(manager);
            const isResigned = resignedTeam.includes(manager);
            
            if (isManagement) {
                return `<span class="badge manager-badge management">${manager} (관리)</span>`;
            } else if (isResigned) {
                return `<span class="badge manager-badge resigned">${manager} (퇴사)</span>`;
            } else {
                const color = colors[manager] || '#f8f9fa';
                return `<span class="badge manager-badge" style="background-color: ${color};">${manager}</span>`;
            }
        }

        function createCompanyBadge(company) {
            if (!company) return '';
            
            
            // 실제 데이터의 거래처들에 파스텔 색상 매핑
            const colors = {};
            
            // 색상 팔레트 (예쁜 파스텔 톤만, 회색 제거)
            const pastelColors = [
                '#FFE4E1', '#E6E6FA', '#F0F8FF', '#F5FFFA', '#FFF8DC', 
                '#FFEFD5', '#FFE4B5', '#FFDAB9', '#EEE8AA', '#F0E68C',
                '#E8F5E8', '#E0F2F1', '#E1F5FE', '#F3E5F5', '#FFE4E6', 
                '#FFEBEE', '#FFF3E0', '#FFFDE7', '#FFB6C1', '#FFC0CB',
                '#FFCCCB', '#FFD0DC', '#d4edda', '#fff3cd', '#f8d7da',
                '#d1ecf1', '#e6f3ff', '#f5e6ff', '#fff0e6', '#e6fff0'
            ];
            
            // 주요 거래처 별도 색상 지정 (신규 프로젝트 자동완성용 대기업들)
            const majorCompanies = {
                '인터넷': '#e1f5fe',      // 연한 하늘색 (주요 거래처)
                '삼성': '#fff3cd',        // 연한 노란색
                'LG': '#f0f9ff',         // 매우 연한 파란색
                '현대': '#ffeaa7',       // 연한 복숭아색
                '롯데': '#ffe4e6',       // 연한 핑크색
                '포스코': '#e6f3ff',     // 연한 하늘색
                'SK': '#f5e6ff',         // 연한 라벤더색
                '한화': '#fff0e6',       // 연한 살구색
                '효성': '#e6fff0',       // 연한 민트색
                'GS': '#fff5e6'          // 연한 베이지색
            };
            
            // 실제 거래처별 개별 색상 지정 (구글 시트에 등록된 거래처들)
            const actualCompanies = {
                '피이스앤 마케팅': '#e8f5e8',  // 연한 연두색
                'P&S마케팅': '#e8f5e8',      // 다른 표기 방식
                '피앤에스마케팅': '#e8f5e8',   // 또 다른 표기 방식
                '피&에스마케팅': '#e8f5e8'     // 또 다른 표기 방식
            };
            
            // 거래처명이 들어오면 실제 거래처 우선, 주요 거래처 다음, 없으면 해시 기반 색상 할당
            const getCompanyColor = (company) => {
                if (!company) return '#f8f9fa';
                
                // 공백 제거 및 정규화
                const normalizedCompany = company.trim();
                
                // 실제 거래처 색상이 있으면 최우선 사용
                if (actualCompanies[normalizedCompany]) {
                    return actualCompanies[normalizedCompany];
                }
                
                // 주요 거래처 색상이 있으면 사용
                if (majorCompanies[normalizedCompany]) {
                    return majorCompanies[normalizedCompany];
                }
                
                // 문자열을 숫자로 변환 (간단한 해시)
                let hash = 0;
                for (let i = 0; i < normalizedCompany.length; i++) {
                    const char = normalizedCompany.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // 32비트 정수로 변환
                }
                
                // 색상 인덱스 결정
                const colorIndex = Math.abs(hash) % pastelColors.length;
                return pastelColors[colorIndex];
            };
            
            const color = getCompanyColor(company);
            return `<span class="badge company-badge" style="background-color: ${color};">${company}</span>`;
        }

        // 유틸리티 함수들
        function formatCurrency(amount) {
            if (!amount) return '0원';
            return new Intl.NumberFormat('ko-KR').format(amount) + '원';
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            // YYYY-MM-DD 형식으로 변환
            return date.getFullYear() + '-' + 
                   String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(date.getDate()).padStart(2, '0');
        }

        // 카드 인라인 편집 함수들
        function toggleCardEdit(projectCode, cardType) {
            const card = document.getElementById(`card-${cardType}-${projectCode}`);
            const editBtn = card.querySelector('.edit-btn');
            const saveBtn = card.querySelector('.save-btn');
            const cancelBtn = card.querySelector('.cancel-btn');
            const editableValues = card.querySelectorAll('.editable-value');
            
            // 편집 모드 활성화
            editBtn.classList.add('d-none');
            saveBtn.classList.remove('d-none');
            cancelBtn.classList.remove('d-none');
            
            // 각 필드를 입력 필드로 변경
            editableValues.forEach(valueDiv => {
                const currentValue = valueDiv.textContent === '-' ? '' : valueDiv.textContent;
                const fieldName = valueDiv.dataset.field;
                
                // 원본 값 저장
                valueDiv.dataset.originalValue = currentValue;
                
                // input 요소 생성
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentValue;
                input.className = 'form-control form-control-sm inline-edit-input';
                input.style.fontSize = '0.85rem';
                input.style.padding = '0.2rem 0.4rem';
                input.style.height = 'auto';
                input.dataset.field = fieldName;
                
                // 특정 필드에 대한 입력 유형 설정
                if (fieldName === '담당자 이메일') {
                    input.type = 'email';
                } else if (fieldName === '담당자 연락처') {
                    input.type = 'tel';
                    input.pattern = '[0-9]{3}-[0-9]{4}-[0-9]{4}';
                }
                
                valueDiv.innerHTML = '';
                valueDiv.appendChild(input);
            });
            
            // 첫 번째 입력 필드에 포커스
            const firstInput = card.querySelector('.inline-edit-input');
            if (firstInput) firstInput.focus();
        }
        
        function saveCardEdit(projectCode, cardType) {
            const card = document.getElementById(`card-${cardType}-${projectCode}`);
            const inputs = card.querySelectorAll('.inline-edit-input');
            const updatedData = {};
            
            // 변경된 데이터 수집 (구글 시트 컬럼명 그대로 사용)
            inputs.forEach(input => {
                const fieldName = input.dataset.field;
                const newValue = input.value.trim() || '';
                updatedData[fieldName] = newValue;
            });
            
            // 프로젝트 코드 추가
            updatedData['projectCode'] = projectCode;
            
            // 새 API 엔드포인트 호출
            console.log('인라인 업데이트 요청:', updatedData);
            
            fetch('/api/projects/' + encodeURIComponent(projectCode), {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updatedData)
            })
            .then(response => {
                console.log('응답 상태:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                if (result.ok) {
                    // 성공적으로 저장됨
                    showAlert('변경사항이 저장되었습니다.', 'success');
                    
                    // UI 업데이트
                    inputs.forEach(input => {
                        const valueDiv = input.parentElement;
                        const newValue = input.value.trim() || '-';
                        valueDiv.textContent = newValue;
                        valueDiv.classList.remove('editing');
                    });
                    
                    // 버튼 상태 복원
                    resetCardEditButtons(card);
                    
                    // 테이블 데이터 업데이트
                    updateProjectDataInMemory(projectCode, updatedData);
                    
                } else {
                    showAlert('저장 중 오류가 발생했습니다: ' + result.error, 'danger');
                }
            })
            .catch(error => {
                console.error('저장 오류:', error);
                // 네트워크 오류나 서버 오류를 구분하여 표시
                if (error.message) {
                    showAlert(`저장 중 오류가 발생했습니다: ${error.message}`, 'danger');
                } else {
                    showAlert('저장 중 오류가 발생했습니다. 네트워크 연결을 확인해주세요.', 'danger');
                }
            });
        }
        
        function cancelCardEdit(projectCode, cardType) {
            const card = document.getElementById(`card-${cardType}-${projectCode}`);
            const inputs = card.querySelectorAll('.inline-edit-input');
            
            // 원래 값으로 복원
            inputs.forEach(input => {
                const valueDiv = input.parentElement;
                const originalValue = valueDiv.dataset.originalValue || '-';
                valueDiv.textContent = originalValue;
                valueDiv.classList.remove('editing');
            });
            
            // 버튼 상태 복원
            resetCardEditButtons(card);
        }
        
        function resetCardEditButtons(card) {
            const editBtn = card.querySelector('.edit-btn');
            const saveBtn = card.querySelector('.save-btn');
            const cancelBtn = card.querySelector('.cancel-btn');
            
            editBtn.classList.remove('d-none');
            saveBtn.classList.add('d-none');
            cancelBtn.classList.add('d-none');
        }
        
        function updateProjectDataInMemory(projectCode, updatedData) {
            // 메모리에 있는 projectsData 업데이트
            const projectIndex = projectsData.findIndex(p => p['프로젝트 코드'] === projectCode);
            if (projectIndex !== -1) {
                Object.keys(updatedData).forEach(key => {
                    if (key !== '프로젝트 코드') {
                        projectsData[projectIndex][key] = updatedData[key];
                    }
                });
            }
        }
        
        // 폴더 열기 함수
        function openFolder(path) {
            if (path) {
                // Windows 경로 형식 확인 및 복사
                const formattedPath = path.replace(/\//g, '\\');
                copyToClipboard(formattedPath);
                showAlert('폴더 경로가 클립보드에 복사되었습니다. Windows 탐색기에 붙여넣기(Ctrl+V) 하세요.', 'info');
            }
        }
        
        // 클립보드에 복사 함수
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(
                    () => {
                        // 복사 버튼 클릭 시 시각적 피드백
                        event.target.closest('button')?.classList.add('btn-success');
                        setTimeout(() => {
                            event.target.closest('button')?.classList.remove('btn-success');
                        }, 1000);
                    },
                    (err) => {
                        console.error('클립보드 복사 실패:', err);
                        // 대체 방법 사용
                        fallbackCopyToClipboard(text);
                    }
                );
            } else {
                // 대체 방법 사용
                fallbackCopyToClipboard(text);
            }
        }
        
        // 대체 클립보드 복사 방법
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('클립보드 복사 실패:', err);
            }
            document.body.removeChild(textArea);
        }
        
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert_' + Date.now();
            
            const alertHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" id="${alertId}">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.innerHTML = alertHTML;
            
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>